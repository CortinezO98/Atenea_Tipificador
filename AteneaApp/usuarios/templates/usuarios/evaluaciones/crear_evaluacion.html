{% extends "usuarios/base/base.html" %}
{% load static %}
{% block title %}Crear Evaluación{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <form method="post">
        {% csrf_token %}
        <!-- Flag anónimo que viaja al backend -->
        <input type="checkbox" name="es_anonimo" id="es_anonimo" value="1" class="d-none">

        <!-- Tarjeta de Datos Básicos -->
        <div class="card shadow mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="h5 mb-0"><i class="bi bi-person-badge me-2"></i>Datos del Ciudadano</h3>
            <!-- Indicador de estado -->
            <span id="estado_ciudadano" class="badge bg-light text-dark" style="display:none;">
              <i class="bi bi-info-circle me-1"></i>
              <span id="estado_texto">Nuevo ciudadano</span>
            </span>
          </div>
          <div class="card-body">
            <!-- Alerta informativa -->
            <div id="alerta_ciudadano_existente" class="alert alert-info alert-dismissible" style="display:none;">
              <i class="bi bi-info-circle-fill me-2"></i>
              <strong>Ciudadano encontrado:</strong> Los datos están bloqueados para edición.
              Solo se puede modificar el número de identificación para buscar otro ciudadano.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label"><i class="bi bi-broadcast-pin me-1"></i>Tipo de Canal <span class="text-danger">*</span></label>
                <select name="tipo_canal" id="tipo_canal" class="form-select" required>
                  <option value="" disabled selected>Seleccionar...</option>
                  {% for tc in tipos_canal %}
                    <option value="{{ tc.id }}">{{ tc.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="numero_identificacion" class="form-label">
                  <i class="bi bi-123 me-1"></i>Número de Identificación
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input
                    type="text"
                    name="numero_identificacion"
                    id="numero_identificacion"
                    class="form-control"
                    maxlength="10"
                    pattern="^\d{1,10}$"
                    inputmode="numeric"
                    title="Solo números (máx. 10)."
                    required>
                  <button type="button" id="btn_anonimo" class="btn btn-outline-info" title="Cargar ciudadano anónimo">
                    <i class="bi bi-person-fill-x me-1"></i>Anónimo
                  </button>
                  <button type="button" id="btn_limpiar_busqueda" class="btn btn-outline-secondary"
                          style="display:none;" title="Limpiar búsqueda">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                <small class="text-muted">Ingrese el número para buscar ciudadano existente</small>
              </div>

              <div class="col-md-6">
                <label for="tipo_identificacion" class="form-label">
                  <i class="bi bi-card-checklist me-1"></i>Tipo de Identificación
                  <span class="text-danger">*</span>
                </label>
                <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" required>
                  <option value="" selected disabled>Seleccionar...</option>
                  {% for tipo in tiposIdentificacion %}
                    <option value="{{tipo.id}}">{{tipo.nombre}}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label for="nombre" class="form-label">
                  <i class="bi bi-person-circle me-1"></i>Nombre Completo
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  name="nombre"
                  id="nombre"
                  class="form-control"
                  maxlength="255"
                  pattern="^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ .'-]{2,255}$"
                  title="Solo letras y espacios (admite acentos, punto y guion)."
                  required>
              </div>

              <div class="col-md-6">
                <label for="conversacion_id" class="form-label">
                  <i class="bi bi-chat-dots me-1"></i>ID Conversación
                  <span class="text-danger">*</span>
                </label>
                <input type="text" name="conversacion_id" id="conversacion_id" class="form-control" maxlength="250" required>
                <div class="invalid-feedback">Ingrese un ID de conversación válido (mín. 5 caracteres)</div>
              </div>

              <!-- Correo -->
              <div class="col-md-6">
                <label for="correo" class="form-label">
                  <i class="bi bi-envelope me-1"></i>Correo electrónico
                </label>
                <input
                  type="email"
                  name="correo"
                  id="correo"
                  class="form-control"
                  maxlength="254"
                  inputmode="email"
                  pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
                  title="Debe ser un correo válido con @ (ej: usuario@dominio.com)">
              </div>

              <!-- Teléfono -->
              <div class="col-md-6">
                <label for="telefono" class="form-label">
                  <i class="bi bi-telephone me-1"></i>Teléfono del que se comunica
                </label>
                <input
                  type="text"
                  name="telefono"
                  id="telefono"
                  class="form-control"
                  maxlength="20"
                  inputmode="numeric"
                  pattern="^\d{0,20}$"
                  title="Solo números (máx. 20).">
              </div>

              <!-- NUEVO: Teléfono Inconcer (solo visible en Anónimo para Agente) -->
              <div class="col-md-6" id="wrap_telefono_inconcer" style="display:none;">
                <label for="telefono_inconcer" class="form-label">
                  <i class="bi bi-telephone-inbound me-1"></i>Teléfono Inconcert
                </label>
                <input
                  type="text"
                  name="telefono_inconcer"
                  id="telefono_inconcer"
                  class="form-control"
                  maxlength="20"
                  inputmode="numeric"
                  pattern="^\d{0,20}$"
                  placeholder="Teléfono que llega desde Inconcer"
                  title="Solo números (máx. 20).">
              </div>

              <!-- Dirección -->
              <div class="col-md-6">
                <label for="direccion_residencia" class="form-label">
                  <i class="bi bi-geo-alt me-1"></i>Dirección de residencia
                </label>
                <input type="text" name="direccion_residencia" id="direccion_residencia" class="form-control" maxlength="255">
              </div>

              <!-- País -->
              <div class="col-md-6">
                <label for="pais" class="form-label">
                  <i class="bi bi-globe me-1"></i>País
                </label>
                <select name="pais" id="pais" class="form-select">
                  <option value="" disabled selected>Seleccionar país...</option>
                  {% for p in paises %}
                    <option value="{{ p.id }}">{{ p.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Ciudad -->
              <div class="col-md-6">
                <label for="ciudad" class="form-label">
                  <i class="bi bi-building me-1"></i>Ciudad
                </label>
                <input type="text" name="ciudad" id="ciudad" class="form-control" maxlength="100">
              </div>

              <input type="text" name="cuidadano_id" id="cuidadano_id" value="" hidden>

              <div class="col-md-4">
                <label class="form-label">Sexo</label>
                <select name="sexo" id="sexo" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in sexos %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Cuál es tu género?</label>
                <select name="genero" id="genero" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in generos %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Cuál es tu orientación sexual?</label>
                <select name="orientacion" id="orientacion" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in orientaciones %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Tienes alguna discapacidad?</label>
                <select name="tiene_discapacidad" id="tiene_discapacidad" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in tiene_discapacidades %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-8" id="wrap_discapacidad" style="display:none;">
                <label class="form-label">¿Cuál discapacidad?</label>
                <select name="discapacidad" id="discapacidad" class="form-select">
                  <option value="">Seleccionar...</option>
                  {% for x in discapacidades %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Cuál es tu rango de edad?</label>
                <select name="rango_edad" id="rango_edad" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in rangos_edad %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Cuál es tu nivel educativo?</label>
                <select name="nivel_educativo" id="nivel_educativo" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in niveles_educativos %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">¿Perteneces a algún grupo étnico?</label>
                <select name="grupo_etnico" id="grupo_etnico" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in grupos_etnicos %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-8">
                <label class="form-label">¿Perteneces a alguno de los siguientes grupos poblacionales?</label>
                <select name="grupo_poblacional" id="grupo_poblacional" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in grupos_poblacionales %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Estrato socioeconómico</label>
                <select name="estrato" id="estrato" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in estratos %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Localidad en Bogotá</label>
                <select name="localidad" id="localidad" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in localidades %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Te comunicas en calidad de</label>
                <select name="calidad_comunicacion" id="calidad_comunicacion" class="form-select">
                  <option value="" selected>Seleccionar...</option>
                  {% for x in calidades %}<option value="{{x.id}}">{{x.nombre}}</option>{% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Tarjeta de Niveles -->
        <div class="card shadow mb-4">
          <div class="card-header bg-info text-white">
            <h3 class="h5 mb-0"><i class="bi bi-diagram-3 me-2"></i>Niveles</h3>
          </div>
          <div class="card-body">
            <div class="row g-3">

              <!-- === NIVELES (únicamente) === -->
              <div class="col-md-4">
                <label for="nivel1" class="form-label"><i class="bi bi-list-nested me-1"></i>Nivel 1 <span class="text-danger">*</span></label>
                <select id="nivel1" name="nivel1" class="form-select" required></select>
              </div>
              <div class="col-md-4">
                <label for="nivel2" class="form-label">Nivel 2</label>
                <select id="nivel2" name="nivel2" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel3" class="form-label">Nivel 3</label>
                <select id="nivel3" name="nivel3" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel4" class="form-label">Nivel 4</label>
                <select id="nivel4" name="nivel4" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel5" class="form-label">Nivel 5</label>
                <select id="nivel5" name="nivel5" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel6" class="form-label">Nivel 6</label>
                <select id="nivel6" name="nivel6" class="form-select"></select>
              </div>
              <!-- === /NIVELES === -->

              <!-- Observaciones -->
              <div class="col-12">
                <label for="observacion" class="form-label">
                  <i class="bi bi-chat-text me-1"></i>Observaciones
                  <span class="text-danger">*</span>
                </label>
                <textarea name="observacion" id="observacion" class="form-control" rows="3"
                          placeholder="Observaciones generales" required></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-4">
          <a href="{% url 'index' %}" class="btn btn-outline-secondary mx-2">Cancelar</a>
          <button type="reset" class="btn btn-secondary mx-2" id="btn_limpiar">
            <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Campos
          </button>
          <button type="submit" class="btn btn-primary mx-2" >
            <i class="bi bi-save me-2"></i>Guardar Evaluación
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  // ==================== VARIABLES GLOBALES ====================
  let ciudadanoExistente = false;
  const camposCiudadano = [
    '#tipo_identificacion', '#nombre', '#correo', '#telefono',
    '#direccion_residencia', '#pais', '#ciudad'
  ];

  // ==================== AUXILIARES ====================
  function mostrarMensaje(mensaje, tipo = "warning") {
    Swal.fire({
      text: mensaje,
      icon: tipo,
      timer: tipo === "success" ? 3000 : undefined,
      showConfirmButton: tipo !== "success"
    });
  }

  function limpiarSelect(selector, placeholder) {
    $(selector).empty().append(`<option value="" disabled selected>${placeholder}</option>`);
  }

  // ==================== BLOQUEO DE CAMPOS (ciudadano) ====================
  function bloquearCamposCiudadano(bloquear = true) {
    camposCiudadano.forEach(function (campo) {
      const $el = $(campo);
      if (bloquear) {
        $el.prop('readonly', true).addClass('campo-bloqueado');
        if ($el.is('select')) {
          $el.prop('disabled', true);
          const hiddenName = $el.attr('name') + '_hidden';
          const hiddenValue = $el.val();
          $(`input[name="${hiddenName}"]`).remove();
          if (hiddenValue) {
            $el.after(`<input type="hidden" name="${$el.attr('name')}" value="${hiddenValue}">`);
          }
        }
        if (!$('#estilos-bloqueados').length) {
          $('head').append(`
            <style id="estilos-bloqueados">
              .campo-bloqueado{background-color:#f8f9fa!important;border-color:#dee2e6!important;color:#6c757d!important;cursor:not-allowed!important}
              .campo-bloqueado:focus{box-shadow:none!important}
              select.campo-bloqueado{pointer-events:none!important}
            </style>
          `);
        }
      } else {
        $el.prop('readonly', false).prop('disabled', false).removeClass('campo-bloqueado');
        if ($el.is('select')) {
          $(`input[name="${$el.attr('name')}"][type="hidden"]`).remove();
        }
      }
    });
  }

  function actualizarEstadoCiudadano(esExistente, datos = null) {
    ciudadanoExistente = esExistente;
    const $estado = $('#estado_ciudadano');
    const $texto  = $('#estado_texto');
    const $alerta = $('#alerta_ciudadano_existente');
    const $btnL   = $('#btn_limpiar_busqueda');

    if (esExistente && datos) {
      $texto.text('Ciudadano existente');
      $estado.removeClass('bg-light text-dark').addClass('bg-success text-white').show();
      $alerta.slideDown();
      $btnL.show();
      bloquearCamposCiudadano(true);
      mostrarMensaje(`Ciudadano encontrado: ${datos.nombre}`, 'success');
    } else {
      $texto.text('Nuevo ciudadano');
      $estado.removeClass('bg-success text-white').addClass('bg-warning text-dark').show();
      $alerta.slideUp();
      $btnL.hide();
      bloquearCamposCiudadano(false);
    }
  }

  function limpiarBusquedaCiudadano() {
    $('#numero_identificacion').val('');
    camposCiudadano.forEach(c => $(c).val(''));
    $('#cuidadano_id').val('');
    actualizarEstadoCiudadano(false);
    $('#numero_identificacion').focus();
  }

  // ==================== ANÓNIMO ====================
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  $('#btn_anonimo').on('click', function () {
    $('#numero_identificacion').val(NUMERO_ANONIMO).trigger('change');
    $('#es_anonimo').prop('checked', true);
    $('#correo').val('');
    $('#telefono').val('');
    Swal.fire({
      title: 'Cargando ciudadano anónimo...',
      icon: 'info',
      timer: 1500,
      showConfirmButton: false,
      toast: true,
      position: 'top-end'
    });
  });

  $('#btn_limpiar_busqueda').on('click', function () {
    Swal.fire({
      title: '¿Limpiar búsqueda?',
      text: 'Se limpiará la información del ciudadano actual y podrá buscar otro.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar',
      cancelButtonText: 'Cancelar'
    }).then((r) => { if (r.isConfirmed) limpiarBusquedaCiudadano(); });
  });

  // ==================== PREGUNTAS ADICIONALES (si existen en tu template) ====================
  $('input[name="se_comunica_uri"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#ciudad_municipio_container');
    const $inp  = $('#ciudad_municipio_uri');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $inp.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $inp.prop('required', false).val('');
      });
    }
  });

  $('input[name="consulta_juridica"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#abogado_container');
    const $sel  = $('#abogado');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $sel.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $sel.prop('required', false).val('');
      });
    }
  });

  // ==================== DISCAPACIDAD (toggle) ====================
  function toggleDiscapacidad(){
    const val = $('#tiene_discapacidad').val();
    if (val === '1'){ // "Si" (id=1 según seeders)
      $('#wrap_discapacidad').stop(true, true).slideDown(150);
      $('#discapacidad').prop('required', true);
    } else {
      $('#wrap_discapacidad').stop(true, true).slideUp(150);
      $('#discapacidad').prop('required', false).val('');
    }
  }
  // Exponer a window para que otros scripts puedan invocarla
  window.toggleDiscapacidad = toggleDiscapacidad;

  $('#tiene_discapacidad').on('change', toggleDiscapacidad);
  toggleDiscapacidad(); // init

  // ==================== BÚSQUEDA DE CIUDADANO ====================
  $('#numero_identificacion').on('change blur', function () {
    const numero = $(this).val().trim();
    if (!numero) { $('#cuidadano_id').val(''); actualizarEstadoCiudadano(false); return; }

    $(this).prop('disabled', true);
    const $badge = $('#estado_ciudadano');
    const $txt   = $('#estado_texto');
    $txt.text('Buscando...');
    $badge.removeClass().addClass('badge bg-info text-white').show();

    $.ajax({
      url: '/api/ciudadano/',
      method: 'GET',
      data: { numero_identificacion: numero },
      success: function (r) {
        $('#numero_identificacion').prop('disabled', false);

        if (r && r.id) {
          // Básicos
          $('#tipo_identificacion').val(r.tipo_identificacion_id);
          $('#nombre').val(r.nombre);
          $('#correo').val(r.correo || '');
          $('#telefono').val(r.telefono || '');
          $('#direccion_residencia').val(r.direccion_residencia || '');
          $('#pais').val(r.pais_id || '');
          $('#ciudad').val(r.ciudad || '');
          $('#cuidadano_id').val(r.id);

          // ===== NUEVOS CAMPOS (IDs desde API; no falla si no vienen) =====
          if (typeof r.sexo_id !== 'undefined') $('#sexo').val(r.sexo_id || '');
          if (typeof r.genero_id !== 'undefined') $('#genero').val(r.genero_id || '');
          if (typeof r.orientacion_id !== 'undefined') $('#orientacion').val(r.orientacion_id || '');
          if (typeof r.tiene_discapacidad_id !== 'undefined') $('#tiene_discapacidad').val(r.tiene_discapacidad_id || '');
          if (typeof r.discapacidad_id !== 'undefined') $('#discapacidad').val(r.discapacidad_id || '');
          if (typeof r.rango_edad_id !== 'undefined') $('#rango_edad').val(r.rango_edad_id || '');
          if (typeof r.nivel_educativo_id !== 'undefined') $('#nivel_educativo').val(r.nivel_educativo_id || '');
          if (typeof r.grupo_etnico_id !== 'undefined') $('#grupo_etnico').val(r.grupo_etnico_id || '');
          if (typeof r.grupo_poblacional_id !== 'undefined') $('#grupo_poblacional').val(r.grupo_poblacional_id || '');
          if (typeof r.estrato_id !== 'undefined') $('#estrato').val(r.estrato_id || '');
          if (typeof r.localidad_id !== 'undefined') $('#localidad').val(r.localidad_id || '');
          if (typeof r.calidad_comunicacion_id !== 'undefined') $('#calidad_comunicacion').val(r.calidad_comunicacion_id || '');

          // Acomodar UI de discapacidad según lo que llegó
          toggleDiscapacidad();

          actualizarEstadoCiudadano(true, r);
        } else {
          $('#cuidadano_id').val('');
          actualizarEstadoCiudadano(false);
          toggleDiscapacidad();
        }

        if ($('#numero_identificacion').val().trim() === NUMERO_ANONIMO) {
          $('#correo').val(''); $('#telefono').val('');
          $('#es_anonimo').prop('checked', true);
          applyAnonUI(); // definida en el script adicional
        }
      },
      error: function (xhr) {
        $('#numero_identificacion').prop('disabled', false);
        $('#cuidadano_id').val('');
        actualizarEstadoCiudadano(false);
        toggleDiscapacidad();
        if (xhr.status === 404) {
          mostrarMensaje('Ciudadano no encontrado. Puede proceder con el registro.', 'info');
        } else {
          mostrarMensaje('Error al buscar ciudadano. Intente nuevamente.');
        }
      }
    });
  });

  // ==================== NIVELES (N1..N6) ====================
  // Helpers para selects y "wrappers" (div.col-md-4)
  function sel(n){ return $(`#nivel${n}`); }
  function wrap(n){ return sel(n).closest('.col-md-4'); }

  function limpiarSelectConPlaceholder($sel, placeholder) {
    $sel.empty().append(`<option value="" selected disabled>${placeholder}</option>`);
  }
  function fillSelect($sel, items, placeholder) {
    limpiarSelectConPlaceholder($sel, placeholder);
    (items || []).forEach(it => $sel.append(`<option value="${it.id}">${it.nombre}</option>`));
  }
  // Mostrar/ocultar un nivel y habilitar/deshabilitar su select
  function showNivel(n, show) {
    const $s = sel(n), $w = wrap(n);
    if (show) {
      $w.show();
      $s.prop('disabled', false);
    } else {
      $w.hide();
      $s.prop('disabled', true).val('');
    }
  }
  // Limpia y oculta desde "desde" hasta 6; N1 queda visible por defecto
  function resetNivelesDesde(desde) {
    for (let n = desde; n <= 6; n++) {
      const $s = sel(n);
      fillSelect($s, [], `Seleccione Nivel ${n}...`);
      // N1 es siempre requerido; los demás solo si tienen hijos
      $s.prop('required', n === 1);
      if (n === 1 && desde === 1) {
        showNivel(1, true);
      } else if (n > 1) {
        showNivel(n, false);
      }
    }
  }
  async function fetchNiveles(nivel, padreId=null) {
    const params = new URLSearchParams({ nivel: String(nivel) });
    if (nivel > 1 && padreId) params.set('padre_id', padreId);
    const res = await fetch(`/api/niveles/?${params.toString()}`);
    if (!res.ok) return [];
    return res.json();
  }
  async function cargarNivel1() {
    resetNivelesDesde(1);
    const data = await fetchNiveles(1);
    fillSelect(sel(1), data, 'Seleccione Nivel 1...');
    showNivel(1, true);
  }
  async function cargarHijos(nivelHijo, padreId) {
    // Limpia y oculta niveles desde el hijo
    resetNivelesDesde(nivelHijo);
    if (!padreId) return;

    const data = await fetchNiveles(nivelHijo, padreId);
    fillSelect(sel(nivelHijo), data, `Seleccione Nivel ${nivelHijo}...`);

    if (data.length > 0) {
      // Hay hijos → mostrar el nivel hijo y exigirlo
      showNivel(nivelHijo, true);
      sel(nivelHijo).prop('required', true);
    } else {
      // No hay hijos → mantener ocultos los siguientes y no requeridos
      for (let n = nivelHijo; n <= 6; n++) {
        sel(n).prop('required', false);
        showNivel(n, false);
      }
    }
  }

  // Encadenar niveles (si el actual cambia, cargar el siguiente)
  sel(1).on('change', function(){ cargarHijos(2, $(this).val()); });
  sel(2).on('change', function(){ cargarHijos(3, $(this).val()); });
  sel(3).on('change', function(){ cargarHijos(4, $(this).val()); });
  sel(4).on('change', function(){ cargarHijos(5, $(this).val()); });
  sel(5).on('change', function(){ cargarHijos(6, $(this).val()); });

  // ==================== VALIDACIONES (propias de niveles y preguntas extra) ====================
  $('form').on('submit', function (e) {
    // N1 siempre requerido
    if (!sel(1).val()) {
      e.preventDefault(); Swal.fire({icon:'error', title:'Dato faltante', text:'Por favor seleccione el Nivel 1.'}); sel(1).focus(); return false;
    }
    // Si un nivel está visible y tiene opciones (>1 con placeholder), debe seleccionarse
    for (let n = 2; n <= 6; n++) {
      const $s = sel(n);
      const visible = wrap(n).is(':visible');
      const tieneOpciones = $s.find('option').length > 1;
      if (visible && tieneOpciones && !$s.val()) {
        e.preventDefault();
        Swal.fire({icon:'error', title:'Dato faltante', text:`Por favor seleccione el Nivel ${n}.`});
        $s.focus();
        return false;
      }
    }

    // Preguntas adicionales (solo si existen en el DOM)
    const uriSel = $('input[name="se_comunica_uri"]:checked').val();
    if (uriSel === '1' && $('#ciudad_municipio_uri').length && !$('#ciudad_municipio_uri').val().trim()) {
      e.preventDefault(); Swal.fire({icon:'error', title:'Dato faltante', text:'Por favor indique la ciudad/municipio de la URI.'}); $('#ciudad_municipio_uri').focus(); return false;
    }
    const cj = $('input[name="consulta_juridica"]:checked').val();
    if (cj === '1' && $('#abogado').length && !$('#abogado').val()) {
      e.preventDefault(); Swal.fire({icon:'error', title:'Dato faltante', text:'Por favor seleccione un abogado para la consulta jurídica.'}); $('#abogado').focus(); return false;
    }

    // Validación especial ciudadano
    if (ciudadanoExistente) {
      const cid = $('#cuidadano_id').val();
      if (!cid) { e.preventDefault(); Swal.fire({icon:'error', title:'Error', text:'ID de ciudadano no encontrado. Busque nuevamente el ciudadano.'}); $('#numero_identificacion').focus(); return false; }
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); Swal.fire({icon:'error', title:'Error', text:'Error en los datos del ciudadano. Por favor, busque nuevamente.'}); $('#numero_identificacion').focus(); return false; }
      $('.campo-bloqueado').each(function () {
        if ($(this).is('select') && $(this).prop('disabled')) {
          $(this).prop('disabled', false).addClass('temp-enabled-for-submit');
        }
      });
    } else {
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); Swal.fire({icon:'error', title:'Dato faltante', text:'Complete los datos básicos del ciudadano (Número ID, Tipo ID, Nombre).'}); return false; }
    }

    return true;
  });

  // Re–deshabilitar selects bloqueados tras envío (si hubo desbloqueo temporal)
  $('form').on('submit', function () {
    setTimeout(function () {
      $('.temp-enabled-for-submit').each(function () {
        $(this).prop('disabled', true).removeClass('temp-enabled-for-submit');
      });
    }, 100);
  });

  // ==================== LIMPIEZA (RESET) ====================
  function limpiarFormularioCompleto() {
    limpiarBusquedaCiudadano();

    // Preguntas adicionales (si existen)
    $('input[name="se_comunica_uri"]').prop('checked', false);
    $('input[name="consulta_juridica"]').prop('checked', false);
    $('#ciudad_municipio_container').hide();
    $('#abogado_container').hide();
    $('#ciudad_municipio_uri').prop('required', false).val('');
    $('#abogado').prop('required', false).val('');

    // Reset niveles desde N1
    resetNivelesDesde(1);
    cargarNivel1();

    // Otros
    $('#conversacion_id').val('');
    $('#observacion').val('');

    // Reset caracterización (discapacidad)
    $('#tiene_discapacidad').val('');
    $('#discapacidad').val('').prop('required', false);
    $('#wrap_discapacidad').hide();
  }

  $('#btn_limpiar, button[type="reset"]').on('click', function (e) {
    e.preventDefault();
    Swal.fire({
      title: '¿Limpiar formulario?',
      text: 'Se perderán todos los datos ingresados.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar todo',
      cancelButtonText: 'Cancelar'
    }).then((r) => {
      if (r.isConfirmed) {
        limpiarFormularioCompleto();
        Swal.fire({icon:'success', text:'Formulario limpiado correctamente.'});
      }
    });
  });

  // ==================== INICIALIZACIÓN ====================
  $('#numero_identificacion').focus();
  actualizarEstadoCiudadano(false);
  // Cargar N1 al iniciar y ocultar N2..N6
  resetNivelesDesde(1);
  cargarNivel1();
});
</script>

<!-- Script adicional: lógica de “Anónimo” por rol -->
<script>
(function(){
  const IS_SUPERVISOR = {% if is_supervisor %}true{% else %}false{% endif %};
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  const $chkAnon   = $('#es_anonimo');
  const $numId     = $('#numero_identificacion');
  const $correo    = $('#correo');
  const $tel       = $('#telefono');
  const $inconcer  = $('#telefono_inconcer');
  const $wrapIncon = $('#wrap_telefono_inconcer');
  const $tipoCanal = $('#tipo_canal');

  if (!$('#estilos-bloqueados').length) {
    $('head').append(`
      <style id="estilos-bloqueados">
        .campo-bloqueado{background-color:#f8f9fa!important;border-color:#dee2e6!important;color:#6c757d!important;cursor:not-allowed!important}
        .campo-bloqueado:focus{box-shadow:none!important}
        select.campo-bloqueado{pointer-events:none!important}
      </style>
    `);
  }

  const CAMPOS_BLOQUEAR = [
    '#tipo_identificacion', '#nombre', '#direccion_residencia', '#pais', '#ciudad',
    '#sexo', '#genero', '#orientacion', '#tiene_discapacidad', '#discapacidad',
    '#rango_edad', '#nivel_educativo', '#grupo_etnico', '#grupo_poblacional',
    '#estrato', '#localidad', '#calidad_comunicacion'
  ];

  function setDisabled(selOrArr, val){
    const list = Array.isArray(selOrArr) ? selOrArr : [selOrArr];
    list.forEach(sel => {
      const $el = $(sel);
      if (!$el.length) return;
      $el.prop('disabled', val).prop('readonly', val);
      if (val) { $el.addClass('campo-bloqueado'); } else { $el.removeClass('campo-bloqueado'); }
    });
  }

  function syncAnonFlag(){
    const anon = ($numId.val().trim() === NUMERO_ANONIMO) || $chkAnon.is(':checked');
    $chkAnon.prop('checked', anon);
    return anon;
  }

  window.applyAnonUI = function applyAnonUI(){
    if (IS_SUPERVISOR){
      $wrapIncon.hide();
    } else {
      $wrapIncon.show();
    }

    const anon = syncAnonFlag();

    setDisabled(CAMPOS_BLOQUEAR, anon);  // bloquea nuevos campos cuando es anónimo
    setDisabled([$correo, $tel], false); // contacto siempre habilitado
    setDisabled($inconcer, false);       // inconcer siempre habilitado
    setDisabled($tipoCanal, false);      // tipo canal siempre habilitado

    if (anon){
      $correo.attr('placeholder','Correo de contacto (anónimo)');
      $tel.attr('placeholder','Teléfono del que se comunica (anónimo)');
      $inconcer.attr('placeholder','Teléfono Inconcer (anónimo)');
      $('#wrap_discapacidad').stop(true,true).slideUp(150);
      $('#discapacidad').prop('required', false).val('');
    } else {
      $correo.attr('placeholder','');
      $tel.attr('placeholder','Teléfono del que se comunica');
      $inconcer.attr('placeholder','Teléfono que llega desde Inconcer');
      if (typeof window.toggleDiscapacidad === 'function') {
        window.toggleDiscapacidad();
      }
    }
  };

  $numId.on('input change blur', applyAnonUI);
  $chkAnon.on('change', applyAnonUI);
  applyAnonUI();
})();
</script>

<!-- Script de validaciones + ALERTAS (HTML5 + SweetAlert) -->
<script>
(function () {
  const byId = id => document.getElementById(id);
  const onlyDigits = (el, max) => { el.value = el.value.replace(/\D+/g, '').slice(0, max); };

  // Número de identificación: 1–10 dígitos
  const numId = byId('numero_identificacion');
  if (numId) {
    numId.addEventListener('input', () => onlyDigits(numId, 10));
    numId.addEventListener('invalid', function () {
      if (this.validity.patternMismatch || this.validity.valueMissing) {
        this.setCustomValidity('Ingrese solo números (máx. 10).');
      }
    });
    numId.addEventListener('input', function(){ this.setCustomValidity(''); });
  }

  // Nombre: solo letras/espacios/acentos/punto/guion
  const nombre = byId('nombre');
  if (nombre) {
    nombre.addEventListener('invalid', function () {
      if (this.validity.patternMismatch || this.validity.valueMissing) {
        this.setCustomValidity('Ingrese un nombre válido (solo letras, espacios, acentos, punto o guion).');
      }
    });
    nombre.addEventListener('input', function(){ this.setCustomValidity(''); });
  }

  // Correo: formato válido con @
  const correo = byId('correo');
  if (correo) {
    correo.addEventListener('invalid', function () {
      if (this.value && (this.validity.typeMismatch || this.validity.patternMismatch)) {
        this.setCustomValidity('Ingrese un correo válido con @ (ej: usuario@dominio.com).');
      }
    });
    correo.addEventListener('input', function(){ this.setCustomValidity(''); });
  }

  // Teléfonos: 0–20 dígitos (opcionales)
  ['telefono', 'telefono_inconcer'].forEach(id => {
    const el = byId(id);
    if (!el) return;
    el.addEventListener('input', () => onlyDigits(el, 20));
    el.addEventListener('invalid', function () {
      if (this.validity.patternMismatch) {
        this.setCustomValidity('Solo números (máx. 20).');
      }
    });
    el.addEventListener('input', function(){ this.setCustomValidity(''); });
  });

  // ===== ALERTA GLOBAL para cualquier campo inválido (sustituye el tooltip nativo) =====
  // Nota: el evento 'invalid' no burbujea, por eso usamos captura (true).
  document.addEventListener('invalid', function (e) {
    e.preventDefault(); // evita el tooltip del navegador
    const el   = e.target;
    const name = (el.labels && el.labels[0]) ? el.labels[0].innerText.trim() : (el.name || 'Campo');
    const msg  = el.validationMessage || 'Revise el valor ingresado.';
    // Marca visual
    el.classList.add('is-invalid');
    // Alerta
    Swal.fire({
      icon: 'error',
      title: 'Dato inválido',
      html: `<strong>${name}</strong><br>${msg}`
    }).then(() => el.focus());
  }, true);

  // Quitar marca visual al corregir
  document.addEventListener('input', function (e) {
    if (e.target.classList.contains('is-invalid')) {
      e.target.classList.remove('is-invalid');
    }
  }, true);
})();
</script>
{% endblock %}

{% extends "usuarios/base/base.html" %}
{% load static %}
{% block title %}Crear Evaluación{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <form method="post">
        {% csrf_token %}
        <!-- Flag anónimo que viaja al backend -->
        <input type="checkbox" name="es_anonimo" id="es_anonimo" value="1" class="d-none">

        <!-- Tarjeta de Datos Básicos -->
        <div class="card shadow mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="h5 mb-0"><i class="bi bi-person-badge me-2"></i>Datos del Ciudadano</h3>
            <!-- Indicador de estado -->
            <span id="estado_ciudadano" class="badge bg-light text-dark" style="display:none;">
              <i class="bi bi-info-circle me-1"></i>
              <span id="estado_texto">Nuevo ciudadano</span>
            </span>
          </div>
          <div class="card-body">
            <!-- Alerta informativa -->
            <div id="alerta_ciudadano_existente" class="alert alert-info alert-dismissible" style="display:none;">
              <i class="bi bi-info-circle-fill me-2"></i>
              <strong>Ciudadano encontrado:</strong> Los datos están bloqueados para edición.
              Solo se puede modificar el número de identificación para buscar otro ciudadano.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="numero_identificacion" class="form-label">
                  <i class="bi bi-123 me-1"></i>Número de Identificación
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="text" name="numero_identificacion" id="numero_identificacion"
                         class="form-control" maxlength="20" required>
                  <button type="button" id="btn_anonimo" class="btn btn-outline-info" title="Cargar ciudadano anónimo">
                    <i class="bi bi-person-fill-x me-1"></i>Anónimo
                  </button>
                  <button type="button" id="btn_limpiar_busqueda" class="btn btn-outline-secondary"
                          style="display:none;" title="Limpiar búsqueda">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                <small class="text-muted">Ingrese el número para buscar ciudadano existente</small>
              </div>

              <div class="col-md-6">
                <label for="tipo_identificacion" class="form-label">
                  <i class="bi bi-card-checklist me-1"></i>Tipo de Identificación
                  <span class="text-danger">*</span>
                </label>
                <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" required>
                  <option value="" selected disabled>Seleccionar...</option>
                  {% for tipo in tiposIdentificacion %}
                    <option value="{{tipo.id}}">{{tipo.nombre}}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label for="nombre" class="form-label">
                  <i class="bi bi-person-circle me-1"></i>Nombre Completo
                  <span class="text-danger">*</span>
                </label>
                <input type="text" name="nombre" id="nombre" class="form-control" maxlength="255" required>
              </div>

              <div class="col-md-6">
                <label for="conversacion_id" class="form-label">
                  <i class="bi bi-chat-dots me-1"></i>ID Conversación
                  <span class="text-danger">*</span>
                </label>
                <input type="text" name="conversacion_id" id="conversacion_id" class="form-control" maxlength="250" required>
                <div class="invalid-feedback">Ingrese un ID de conversación válido (mín. 5 caracteres)</div>
              </div>

              <!-- Correo -->
              <div class="col-md-6">
                <label for="correo" class="form-label">
                  <i class="bi bi-envelope me-1"></i>Correo electrónico
                </label>
                <input type="email" name="correo" id="correo" class="form-control" maxlength="254">
              </div>

              <!-- Teléfono -->
              <div class="col-md-6">
                <label for="telefono" class="form-label">
                  <i class="bi bi-telephone me-1"></i>Teléfono del que se comunica
                </label>
                <input type="text" name="telefono" id="telefono" class="form-control" maxlength="20">
              </div>

              <!-- NUEVO: Teléfono Inconcer (solo visible en Anónimo para Agente) -->
              <div class="col-md-6" id="wrap_telefono_inconcer" style="display:none;">
                <label for="telefono_inconcer" class="form-label">
                  <i class="bi bi-telephone-inbound me-1"></i>Teléfono Inconcer
                </label>
                <input type="text" name="telefono_inconcer" id="telefono_inconcer"
                       class="form-control" maxlength="20" placeholder="Teléfono que llega desde Inconcer">
              </div>

              <!-- Dirección -->
              <div class="col-md-6">
                <label for="direccion_residencia" class="form-label">
                  <i class="bi bi-geo-alt me-1"></i>Dirección de residencia
                </label>
                <input type="text" name="direccion_residencia" id="direccion_residencia" class="form-control" maxlength="255">
              </div>

              <!-- País -->
              <div class="col-md-6">
                <label for="pais" class="form-label">
                  <i class="bi bi-globe me-1"></i>País
                </label>
                <select name="pais" id="pais" class="form-select">
                  <option value="" disabled selected>Seleccionar país...</option>
                  {% for p in paises %}
                    <option value="{{ p.id }}">{{ p.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Ciudad -->
              <div class="col-md-6">
                <label for="ciudad" class="form-label">
                  <i class="bi bi-building me-1"></i>Ciudad
                </label>
                <input type="text" name="ciudad" id="ciudad" class="form-control" maxlength="100">
              </div>

              <input type="text" name="cuidadano_id" id="cuidadano_id" value="" hidden>
            </div>
          </div>
        </div>

        <!-- Tarjeta de Niveles -->
        <div class="card shadow mb-4">
          <div class="card-header bg-info text-white">
            <h3 class="h5 mb-0"><i class="bi bi-diagram-3 me-2"></i>Niveles</h3>
          </div>
          <div class="card-body">
            <div class="row g-3">

              <!-- === NIVELES (únicamente) === -->
              <div class="col-md-4">
                <label for="nivel1" class="form-label"><i class="bi bi-list-nested me-1"></i>Nivel 1 <span class="text-danger">*</span></label>
                <select id="nivel1" name="nivel1" class="form-select" required></select>
              </div>
              <div class="col-md-4">
                <label for="nivel2" class="form-label">Nivel 2</label>
                <select id="nivel2" name="nivel2" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel3" class="form-label">Nivel 3</label>
                <select id="nivel3" name="nivel3" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel4" class="form-label">Nivel 4</label>
                <select id="nivel4" name="nivel4" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel5" class="form-label">Nivel 5</label>
                <select id="nivel5" name="nivel5" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label for="nivel6" class="form-label">Nivel 6</label>
                <select id="nivel6" name="nivel6" class="form-select"></select>
              </div>
              <!-- === /NIVELES === -->

              <!-- Observaciones -->
              <div class="col-12">
                <label for="observacion" class="form-label">
                  <i class="bi bi-chat-text me-1"></i>Observaciones
                  <span class="text-danger">*</span>
                </label>
                <textarea name="observacion" id="observacion" class="form-control" rows="3"
                          placeholder="Observaciones generales" required></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-4">
          <a href="{% url 'index' %}" class="btn btn-outline-secondary mx-2">Cancelar</a>
          <button type="reset" class="btn btn-secondary mx-2" id="btn_limpiar">
            <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Campos
          </button>
          <button type="submit" class="btn btn-primary mx-2" >
            <i class="bi bi-save me-2"></i>Guardar Evaluación
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  // ==================== VARIABLES GLOBALES ====================
  let ciudadanoExistente = false;
  const camposCiudadano = [
    '#tipo_identificacion', '#nombre', '#correo', '#telefono',
    '#direccion_residencia', '#pais', '#ciudad'
  ];

  // ==================== AUXILIARES ====================
  function mostrarMensaje(mensaje, tipo = "warning") {
    Swal.fire({
      text: mensaje,
      icon: tipo,
      timer: tipo === "success" ? 3000 : undefined,
      showConfirmButton: tipo !== "success"
    });
  }

  function limpiarSelect(selector, placeholder) {
    $(selector).empty().append(`<option value="" disabled selected>${placeholder}</option>`);
  }

  // ==================== BLOQUEO DE CAMPOS (ciudadano) ====================
  function bloquearCamposCiudadano(bloquear = true) {
    camposCiudadano.forEach(function (campo) {
      const $el = $(campo);
      if (bloquear) {
        $el.prop('readonly', true).addClass('campo-bloqueado');
        if ($el.is('select')) {
          $el.prop('disabled', true);
          const hiddenName = $el.attr('name') + '_hidden';
          const hiddenValue = $el.val();
          $(`input[name="${hiddenName}"]`).remove();
          if (hiddenValue) {
            $el.after(`<input type="hidden" name="${$el.attr('name')}" value="${hiddenValue}">`);
          }
        }
        if (!$('#estilos-bloqueados').length) {
          $('head').append(`
            <style id="estilos-bloqueados">
              .campo-bloqueado{background-color:#f8f9fa!important;border-color:#dee2e6!important;color:#6c757d!important;cursor:not-allowed!important}
              .campo-bloqueado:focus{box-shadow:none!important}
              select.campo-bloqueado{pointer-events:none!important}
            </style>
          `);
        }
      } else {
        $el.prop('readonly', false).prop('disabled', false).removeClass('campo-bloqueado');
        if ($el.is('select')) {
          $(`input[name="${$el.attr('name')}"][type="hidden"]`).remove();
        }
      }
    });
  }

  function actualizarEstadoCiudadano(esExistente, datos = null) {
    ciudadanoExistente = esExistente;
    const $estado = $('#estado_ciudadano');
    const $texto  = $('#estado_texto');
    const $alerta = $('#alerta_ciudadano_existente');
    const $btnL   = $('#btn_limpiar_busqueda');

    if (esExistente && datos) {
      $texto.text('Ciudadano existente');
      $estado.removeClass('bg-light text-dark').addClass('bg-success text-white').show();
      $alerta.slideDown();
      $btnL.show();
      bloquearCamposCiudadano(true);
      mostrarMensaje(`Ciudadano encontrado: ${datos.nombre}`, 'success');
    } else {
      $texto.text('Nuevo ciudadano');
      $estado.removeClass('bg-success text-white').addClass('bg-warning text-dark').show();
      $alerta.slideUp();
      $btnL.hide();
      bloquearCamposCiudadano(false);
    }
  }

  function limpiarBusquedaCiudadano() {
    $('#numero_identificacion').val('');
    camposCiudadano.forEach(c => $(c).val(''));
    $('#cuidadano_id').val('');
    actualizarEstadoCiudadano(false);
    $('#numero_identificacion').focus();
  }

  // ==================== ANÓNIMO ====================
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  $('#btn_anonimo').on('click', function () {
    $('#numero_identificacion').val(NUMERO_ANONIMO).trigger('change');
    $('#es_anonimo').prop('checked', true);
    $('#correo').val('');
    $('#telefono').val('');
    Swal.fire({
      title: 'Cargando ciudadano anónimo...',
      icon: 'info',
      timer: 1500,
      showConfirmButton: false,
      toast: true,
      position: 'top-end'
    });
  });

  $('#btn_limpiar_busqueda').on('click', function () {
    Swal.fire({
      title: '¿Limpiar búsqueda?',
      text: 'Se limpiará la información del ciudadano actual y podrá buscar otro.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar',
      cancelButtonText: 'Cancelar'
    }).then((r) => { if (r.isConfirmed) limpiarBusquedaCiudadano(); });
  });

  // ==================== PREGUNTAS ADICIONALES (si existen en tu template) ====================
  $('input[name="se_comunica_uri"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#ciudad_municipio_container');
    const $inp  = $('#ciudad_municipio_uri');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $inp.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $inp.prop('required', false).val('');
      });
    }
  });

  $('input[name="consulta_juridica"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#abogado_container');
    const $sel  = $('#abogado');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $sel.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $sel.prop('required', false).val('');
      });
    }
  });

  // ==================== BÚSQUEDA DE CIUDADANO ====================
  $('#numero_identificacion').on('change blur', function () {
    const numero = $(this).val().trim();
    if (!numero) { $('#cuidadano_id').val(''); actualizarEstadoCiudadano(false); return; }

    $(this).prop('disabled', true);
    const $badge = $('#estado_ciudadano');
    const $txt   = $('#estado_texto');
    $txt.text('Buscando...');
    $badge.removeClass().addClass('badge bg-info text-white').show();

    $.ajax({
      url: '/api/ciudadano/',
      method: 'GET',
      data: { numero_identificacion: numero },
      success: function (r) {
        $('#numero_identificacion').prop('disabled', false);
        if (r && r.id) {
          $('#tipo_identificacion').val(r.tipo_identificacion_id);
          $('#nombre').val(r.nombre);
          $('#correo').val(r.correo || '');
          $('#telefono').val(r.telefono || '');
          $('#direccion_residencia').val(r.direccion_residencia || '');
          $('#pais').val(r.pais_id || '');
          $('#ciudad').val(r.ciudad || '');
          $('#cuidadano_id').val(r.id);
          actualizarEstadoCiudadano(true, r);
        } else {
          $('#cuidadano_id').val('');
          actualizarEstadoCiudadano(false);
        }
        if ($('#numero_identificacion').val().trim() === NUMERO_ANONIMO) {
          $('#correo').val(''); $('#telefono').val('');
          $('#es_anonimo').prop('checked', true);
          applyAnonUI(); // definida en el script adicional
        }
      },
      error: function (xhr) {
        $('#numero_identificacion').prop('disabled', false);
        $('#cuidadano_id').val('');
        actualizarEstadoCiudadano(false);
        if (xhr.status === 404) {
          mostrarMensaje('Ciudadano no encontrado. Puede proceder con el registro.', 'info');
        } else {
          mostrarMensaje('Error al buscar ciudadano. Intente nuevamente.');
        }
      }
    });
  });

  // ==================== NIVELES (N1..N6) ====================
  function limpiarSelectConPlaceholder($sel, placeholder) {
    $sel.empty().append(`<option value="" selected disabled>${placeholder}</option>`);
  }
  function fillSelect($sel, items, placeholder) {
    limpiarSelectConPlaceholder($sel, placeholder);
    (items || []).forEach(it => $sel.append(`<option value="${it.id}">${it.nombre}</option>`));
  }
  async function fetchNiveles(nivel, padreId=null) {
    const params = new URLSearchParams({ nivel: String(nivel) });
    if (nivel > 1 && padreId) params.set('padre_id', padreId);
    const res = await fetch(`/api/niveles/?${params.toString()}`);
    if (!res.ok) return [];
    return res.json();
  }
  function resetNivelesDesde(desde) {
    for (let n = desde; n <= 6; n++) {
      const $s = $(`#nivel${n}`);
      fillSelect($s, [], `Seleccione Nivel ${n}...`);
      $s.prop('required', n === 1);
    }
  }
  async function cargarNivel1() {
    const data = await fetchNiveles(1);
    fillSelect($('#nivel1'), data, 'Seleccione Nivel 1...');
  }
  async function cargarHijos(nivelHijo, padreId) {
    resetNivelesDesde(nivelHijo);
    if (!padreId) return;
    const data = await fetchNiveles(nivelHijo, padreId);
    fillSelect($(`#nivel${nivelHijo}`), data, `Seleccione Nivel ${nivelHijo}...`);
    $(`#nivel${nivelHijo}`).prop('required', data.length > 0);
  }

  // Encadenar niveles
  $('#nivel1').on('change', function(){ cargarHijos(2, $(this).val()); });
  $('#nivel2').on('change', function(){ cargarHijos(3, $(this).val()); });
  $('#nivel3').on('change', function(){ cargarHijos(4, $(this).val()); });
  $('#nivel4').on('change', function(){ cargarHijos(5, $(this).val()); });
  $('#nivel5').on('change', function(){ cargarHijos(6, $(this).val()); });

  // ==================== VALIDACIONES ====================
  $('form').on('submit', function (e) {
    // Niveles: N1 siempre requerido
    if (!$('#nivel1').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione el Nivel 1.'); $('#nivel1').focus(); return false;
    }

    // Si un nivel tiene opciones (más del placeholder), exigir selección antes de seguir
    for (let n = 2; n <= 6; n++) {
      const $s = $(`#nivel${n}`);
      const tieneOpciones = $s.find('option').length > 1;
      if (tieneOpciones && !$s.val()) {
        e.preventDefault();
        mostrarMensaje(`Por favor seleccione el Nivel ${n}.`);
        $s.focus();
        return false;
      }
    }

    // Preguntas adicionales (solo si existen en el DOM)
    const uriSel = $('input[name="se_comunica_uri"]:checked').val();
    if (uriSel === '1' && $('#ciudad_municipio_uri').length && !$('#ciudad_municipio_uri').val().trim()) {
      e.preventDefault(); mostrarMensaje('Por favor indique la ciudad/municipio de la URI.'); $('#ciudad_municipio_uri').focus(); return false;
    }
    const cj = $('input[name="consulta_juridica"]:checked').val();
    if (cj === '1' && $('#abogado').length && !$('#abogado').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione un abogado para la consulta jurídica.'); $('#abogado').focus(); return false;
    }

    // Validación especial ciudadano
    if (ciudadanoExistente) {
      const cid = $('#cuidadano_id').val();
      if (!cid) { e.preventDefault(); mostrarMensaje('Error: ID de ciudadano no encontrado. Busque nuevamente el ciudadano.'); $('#numero_identificacion').focus(); return false; }
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); mostrarMensaje('Error en los datos del ciudadano. Por favor, busque nuevamente.'); $('#numero_identificacion').focus(); return false; }
      $('.campo-bloqueado').each(function () {
        if ($(this).is('select') && $(this).prop('disabled')) {
          $(this).prop('disabled', false).addClass('temp-enabled-for-submit');
        }
      });
    } else {
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); mostrarMensaje('Por favor complete los datos básicos del ciudadano (Número ID, Tipo ID, Nombre).'); return false; }
    }

    return true;
  });

  // Re–deshabilitar selects bloqueados tras envío (si hubo desbloqueo temporal)
  $('form').on('submit', function () {
    setTimeout(function () {
      $('.temp-enabled-for-submit').each(function () {
        $(this).prop('disabled', true).removeClass('temp-enabled-for-submit');
      });
    }, 100);
  });

  // ==================== LIMPIEZA (RESET) ====================
  function limpiarFormularioCompleto() {
    limpiarBusquedaCiudadano();

    // Preguntas adicionales (si existen)
    $('input[name="se_comunica_uri"]').prop('checked', false);
    $('input[name="consulta_juridica"]').prop('checked', false);
    $('#ciudad_municipio_container').hide();
    $('#abogado_container').hide();
    $('#ciudad_municipio_uri').prop('required', false).val('');
    $('#abogado').prop('required', false).val('');

    // Reset niveles desde N1
    resetNivelesDesde(1);
    cargarNivel1();

    // Otros
    $('#conversacion_id').val('');
    $('#observacion').val('');
  }

  $('#btn_limpiar, button[type="reset"]').on('click', function (e) {
    e.preventDefault();
    Swal.fire({
      title: '¿Limpiar formulario?',
      text: 'Se perderán todos los datos ingresados.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar todo',
      cancelButtonText: 'Cancelar'
    }).then((r) => {
      if (r.isConfirmed) {
        limpiarFormularioCompleto();
        mostrarMensaje('Formulario limpiado correctamente.', 'success');
      }
    });
  });

  // ==================== INICIALIZACIÓN ====================
  $('#numero_identificacion').focus();
  actualizarEstadoCiudadano(false);
  // Cargar N1 al iniciar
  cargarNivel1();
});
</script>

<!-- Script adicional: lógica de “Anónimo” por rol -->
<script>
(function(){
  const IS_SUPERVISOR = {% if is_supervisor %}true{% else %}false{% endif %};
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  const $chkAnon   = $('#es_anonimo');
  const $numId     = $('#numero_identificacion');
  const $correo    = $('#correo');
  const $tel       = $('#telefono');
  const $inconcer  = $('#telefono_inconcer');
  const $wrapIncon = $('#wrap_telefono_inconcer');

  const CAMPOS_BLOQUEAR = ['#tipo_identificacion','#nombre','#direccion_residencia','#pais','#ciudad'];

  function setDisabled(selOrArr, val){
    const list = Array.isArray(selOrArr) ? selOrArr : [selOrArr];
    list.forEach(sel => {
      const $el = $(sel);
      if (!$el.length) return;
      $el.prop('disabled', val).prop('readonly', val);
      if (val) { $el.addClass('campo-bloqueado'); } else { $el.removeClass('campo-bloqueado'); }
    });
  }

  function syncAnonFlag(){
    const anon = ($numId.val().trim() === NUMERO_ANONIMO) || $chkAnon.is(':checked');
    $chkAnon.prop('checked', anon);
    return anon;
  }

  window.applyAnonUI = function applyAnonUI(){
    if (IS_SUPERVISOR){
      $wrapIncon.hide();
      return;
    }
    const anon = syncAnonFlag();
    setDisabled(CAMPOS_BLOQUEAR, anon);
    setDisabled([$correo, $tel], false);
    $wrapIncon.show();
    setDisabled($inconcer, false);

    if (anon){
      $correo.attr('placeholder','Correo de contacto (anónimo)');
      $tel.attr('placeholder','Teléfono del que se comunica (anónimo)');
      $inconcer.attr('placeholder','Teléfono Inconcer (anónimo)');
    } else {
      $correo.attr('placeholder','');
      $tel.attr('placeholder','Teléfono del que se comunica');
      $inconcer.attr('placeholder','Teléfono que llega desde Inconcer');
    }
  };

  $numId.on('input change blur', function(){ applyAnonUI(); });
  applyAnonUI();
})();
</script>
{% endblock %}

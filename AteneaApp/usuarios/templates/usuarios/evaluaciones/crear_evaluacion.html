{% extends "usuarios/base/base.html" %}
{% load static %}
{% block title %}Crear Evaluación{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form method="post">
                {% csrf_token %}
                <!-- Flag anónimo que viaja al backend -->
                <input type="checkbox" name="es_anonimo" id="es_anonimo" value="1" class="d-none">
                
                <!-- Tarjeta de Datos Básicos -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="h5 mb-0"><i class="bi bi-person-badge me-2"></i>Datos del Ciudadano</h3>
                        <!-- Indicador de estado -->
                        <span id="estado_ciudadano" class="badge bg-light text-dark" style="display: none;">
                            <i class="bi bi-info-circle me-1"></i>
                            <span id="estado_texto">Nuevo ciudadano</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <!-- Alerta informativa -->
                        <div id="alerta_ciudadano_existente" class="alert alert-info alert-dismissible" style="display: none;">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Ciudadano encontrado:</strong> Los datos están bloqueados para edición. 
                            Solo se puede modificar el número de identificación para buscar otro ciudadano.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="numero_identificacion" class="form-label">
                                    <i class="bi bi-123 me-1"></i>Número de Identificación
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" name="numero_identificacion" id="numero_identificacion" 
                                           class="form-control" maxlength="20" required>
                                    <button type="button" id="btn_anonimo" class="btn btn-outline-info" 
                                            title="Cargar ciudadano anónimo">
                                        <i class="bi bi-person-fill-x me-1"></i>Anónimo
                                    </button>       
                                    <button type="button" id="btn_limpiar_busqueda" class="btn btn-outline-secondary" 
                                            style="display: none;" title="Limpiar búsqueda">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Ingrese el número para buscar ciudadano existente</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="tipo_identificacion" class="form-label">
                                    <i class="bi bi-card-checklist me-1"></i>Tipo de Identificación
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" required>
                                    <option value="" selected disabled>Seleccionar...</option>
                                    {% for tipo in tiposIdentificacion %}
                                        <option value="{{tipo.id}}">{{tipo.nombre}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">
                                    <i class="bi bi-person-circle me-1"></i>Nombre Completo
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="nombre" id="nombre" class="form-control" maxlength="255" required>
                            </div>

                            <div class="col-md-6">
                                <label for="conversacion_id" class="form-label">
                                    <i class="bi bi-chat-dots me-1"></i>ID Conversación
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="conversacion_id" id="conversacion_id" class="form-control" maxlength="250" required>
                                <div class="invalid-feedback">Ingrese un ID de conversación válido (mín. 5 caracteres)</div>
                            </div>

                            <!-- Correo -->
                            <div class="col-md-6">
                                <label for="correo" class="form-label">
                                    <i class="bi bi-envelope me-1"></i>Correo electrónico
                                </label>
                                <input type="email" name="correo" id="correo" class="form-control" maxlength="254">
                            </div>

                            <!-- Teléfono -->
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">
                                    <i class="bi bi-telephone me-1"></i>Teléfono del que se comunica
                                </label>
                                <input type="text" name="telefono" id="telefono" class="form-control" maxlength="20">
                            </div>

                            <!-- NUEVO: Teléfono Inconser (solo visible en Anónimo para Agente) -->
                            <div class="col-md-6" id="wrap_telefono_inconcer" style="display:none;">
                                <label for="telefono_inconcer" class="form-label">
                                    <i class="bi bi-telephone-inbound me-1"></i>Teléfono Inconcer
                                </label>
                                <input type="text" name="telefono_inconcer" id="telefono_inconcer"
                                       class="form-control" maxlength="20" placeholder="Teléfono que llega desde Inconcer">
                            </div>

                            <!-- Dirección -->
                            <div class="col-md-6">
                                <label for="direccion_residencia" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Dirección de residencia
                                </label>
                                <input type="text" name="direccion_residencia" id="direccion_residencia" class="form-control" maxlength="255">
                            </div>

                            <!-- País -->
                            <div class="col-md-6">
                                <label for="pais" class="form-label">
                                    <i class="bi bi-globe me-1"></i>País
                                </label>
                                <select name="pais" id="pais" class="form-select">
                                    <option value="" disabled selected>Seleccionar país...</option>
                                    {% for p in paises %}
                                        <option value="{{ p.id }}">{{ p.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Ciudad -->
                            <div class="col-md-6">
                                <label for="ciudad" class="form-label">
                                    <i class="bi bi-building me-1"></i>Ciudad
                                </label>
                                <input type="text" name="ciudad" id="ciudad" class="form-control" maxlength="100">
                            </div>

                            <input type="text" name="cuidadano_id" id="cuidadano_id" value="" hidden>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta de Tipificación - NUEVA JERARQUÍA -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="h5 mb-0"><i class="bi bi-diagram-3 me-2"></i>Proceso de Tipificación</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Tipo de Canal -->
                            <div class="col-md-6">
                                <label for="tipo_canal" class="form-label">
                                    <i class="bi bi-broadcast me-1"></i>Tipo de Canal
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="tipo_canal" id="tipo_canal" class="form-select" required>
                                    <option value="" selected disabled>Seleccione un tipo de canal...</option>
                                    {% for tipo in tipos_canal %}
                                        <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Segmento -->
                            <div class="col-md-6">
                                <label for="segmento" class="form-label">
                                    <i class="bi bi-diagram-2 me-1"></i>Segmento
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="segmento" id="segmento" class="form-select" required>
                                    <option value="" selected disabled>Seleccione un segmento...</option>
                                </select>
                            </div>

                            <!-- Segmento II (condicional) -->
                            <div class="col-md-6" id="segmento_ii_container" style="display: none;">
                                <label for="segmento_ii" class="form-label">
                                    <i class="bi bi-diagram-3 me-1"></i>Segmento II
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="segmento_ii" id="segmento_ii" class="form-select">
                                    <option value="" selected disabled>Seleccione un segmento II...</option>
                                </select>
                            </div>

                            <div class="col-md-6" id="segmento_iii_container" style="display: none;">
                                <label for="segmento_iii" class="form-label">
                                    <i class="bi bi-diagram-3-fill me-1"></i>Segmento III
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="segmento_iii" id="segmento_iii" class="form-select">
                                    <option value="" selected disabled>Seleccione un segmento III...</option>
                                </select>
                            </div>

                            <!-- Tipificación -->
                            <div class="col-md-6">
                                <label for="tipificacion" class="form-label">
                                    <i class="bi bi-tag me-1"></i>Tipificación
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="tipificacion" id="tipificacion" class="form-select" required>
                                    <option value="" selected disabled>Seleccione una tipificación...</option>
                                </select>
                            </div>

                            <!-- Categoría -->
                            <div class="col-md-6">
                                <label for="categoria" class="form-label">
                                    <i class="bi bi-menu-button me-1"></i>Categoría
                                    <span class="text-muted small" id="categoria_optional_label" style="display: none;">(Opcional)</span>
                                    <span class="text-danger" id="categoria_required_label">*</span>
                                </label>
                                <select name="categoria" id="categoria" class="form-select" required>
                                    <option value="" selected disabled>Selecciona una categoría</option>
                                </select>
                            </div>

                            <!-- Subcategoría (condicional) -->
                            <div class="col-md-6" id="subcategoria_container" style="display: none;">
                                <label for="subcategoria" class="form-label">
                                    <i class="bi bi-menu-button-wide me-1"></i>Sub Categoría
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="subcategoria" id="subcategoria" class="form-select">
                                    <option value="" selected disabled>Selecciona una sub categoría</option>
                                </select>
                            </div>

                            <!-- Sub Categoría II (condicional) -->
                            <div class="col-md-6" id="subcategoria_ii_container" style="display: none;">
                                <label for="subcategoria_ii" class="form-label">
                                    <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría II
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="subcategoria_ii" id="subcategoria_ii" class="form-select">
                                    <option value="" selected disabled>Selecciona una sub categoría II</option>
                                </select>
                            </div>

                            <!-- Sub Categoría III (condicional) -->
                            <div class="col-md-6" id="subcategoria_iii_container" style="display: none;">
                                <label for="subcategoria_iii" class="form-label">
                                    <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría III
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="subcategoria_iii" id="subcategoria_iii" class="form-select">
                                    <option value="" selected disabled>Selecciona una sub categoría III</option>
                                </select>
                            </div>

                            <!-- Campo especial para "OTROS DELITOS" -->
                            <div class="col-12" id="otros_delitos_container" style="display: none;">
                                <label for="cual_otro_delito" class="form-label">
                                    <i class="bi bi-question-circle me-1"></i>¿Cuál otro delito?
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="cual_otro_delito" id="cual_otro_delito" class="form-control" maxlength="500" placeholder="Especifique el delito...">
                                <small class="text-muted">Este campo solo se muestra cuando se selecciona 'OTROS DELITOS'</small>
                            </div>

                            <!-- Observaciones -->
                            <div class="col-12">
                                <label for="observacion" class="form-label">
                                    <i class="bi bi-chat-text me-1"></i>Observaciones
                                    <span class="text-danger">*</span>
                                </label>
                                <textarea name="observacion" id="observacion" class="form-control" rows="3" placeholder="Observaciones generales" required></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVA TARJETA: INFORMACIÓN ADICIONAL -->
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h3 class="h5 mb-0"><i class="bi bi-question-circle me-2"></i>Información Adicional</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            
                            <!-- PREGUNTA 1: Se comunica de una URI -->
                            <div class="col-12">
                                <div class="card border-primary border-opacity-25" id="card_uri">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>¿Se comunica de una URI?
                                            <span class="text-danger">*</span>
                                        </h6>
                                        
                                        <div class="row g-3">
                                            <!-- Opciones SI/NO -->
                                            <div class="col-md-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="se_comunica_uri" id="uri_si" value="1" required>
                                                    <label class="form-check-label" for="uri_si">
                                                        <i class="bi bi-check-circle text-success me-1"></i>SÍ
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="se_comunica_uri" id="uri_no" value="0">
                                                    <label class="form-check-label" for="uri_no">
                                                        <i class="bi bi-x-circle text-danger me-1"></i>NO
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Campo Ciudad/Municipio (condicional) -->
                                            <div class="col-md-6" id="ciudad_municipio_container" style="display: none;">
                                                <label for="ciudad_municipio_uri" class="form-label">
                                                    <i class="bi bi-building me-1"></i>Ciudad/Municipio
                                                    <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" name="ciudad_municipio_uri" id="ciudad_municipio_uri" 
                                                       class="form-control" maxlength="200" 
                                                       placeholder="Indique ciudad/municipio">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PREGUNTA 2: Consulta jurídica -->
                            <div class="col-12">
                                <div class="card border-primary border-opacity-25" id="card_consulta">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-briefcase-fill me-2"></i>¿Consulta jurídica?
                                            <span class="text-danger">*</span>
                                        </h6>
                                        
                                        <div class="row g-3">
                                            <!-- Opciones SI/NO -->
                                            <div class="col-md-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="consulta_juridica" id="juridica_si" value="1" required>
                                                    <label class="form-check-label" for="juridica_si">
                                                        <i class="bi bi-check-circle text-success me-1"></i>SÍ
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="consulta_juridica" id="juridica_no" value="0">
                                                    <label class="form-check-label" for="juridica_no">
                                                        <i class="bi bi-x-circle text-danger me-1"></i>NO
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Campo Abogado (condicional) -->
                                            <div class="col-md-6" id="abogado_container" style="display: none;">
                                                <label for="abogado" class="form-label">
                                                    <i class="bi bi-person-badge me-1"></i>Abogado
                                                    <span class="text-danger">*</span>
                                                </label>
                                                <select name="abogado" id="abogado" class="form-select">
                                                    <option value="" selected disabled>Seleccione abogado</option>
                                                    {% for abogado in abogados %}
                                                        <option value="{{ abogado.id }}">{{ abogado.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'index' %}" class="btn btn-outline-secondary mx-2">
                        Cancelar
                    </a>
                    <button type="reset" class="btn btn-secondary mx-2" id="btn_limpiar">
                        <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Campos
                    </button>
                    <button type="submit" class="btn btn-primary mx-2">
                        <i class="bi bi-save me-2"></i>Guardar Evaluación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // ==================== VARIABLES GLOBALES ====================
        let ciudadanoExistente = false;
        const camposCiudadano = [
            '#tipo_identificacion', '#nombre', '#correo', '#telefono', 
            '#direccion_residencia', '#pais', '#ciudad'
        ];

        // ==================== FUNCIONES AUXILIARES ====================
        
        function mostrarMensaje(mensaje, tipo = "warning") {
            Swal.fire({
                text: mensaje,
                icon: tipo,
                timer: tipo === "success" ? 3000 : undefined,
                showConfirmButton: tipo !== "success"
            });
        }

        function limpiarSelect(selector, mensaje) {
            $(selector).empty().append(`<option value="" disabled selected>${mensaje}</option>`);
        }

        function mostrarContainer(containerId, show = true) {
            const container = $(`#${containerId}`);
            
            if (show) {
                container.show();
                container.removeClass('d-none');
            } else {
                container.hide();
                container.addClass('d-none');
                container.find('select, input').prop('required', false);
            }
        }

        

        // ==================== FUNCIONES PARA BLOQUEO DE CAMPOS ====================
        
        function bloquearCamposCiudadano(bloquear = true) {
            camposCiudadano.forEach(function(campo) {
                const elemento = $(campo);
                
                if (bloquear) {
                    // En lugar de disabled, usar readonly para que se envíen los datos
                    elemento.prop('readonly', true);
                    elemento.addClass('campo-bloqueado');
                    
                    // Para selects, deshabilitar pero mantener el valor
                    if (elemento.is('select')) {
                        elemento.prop('disabled', true);
                        // Crear un campo hidden con el mismo valor
                        const hiddenName = elemento.attr('name') + '_hidden';
                        const hiddenValue = elemento.val();
                        
                        // Remover hidden anterior si existe
                        $(`input[name="${hiddenName}"]`).remove();
                        
                        // Crear nuevo hidden
                        if (hiddenValue) {
                            elemento.after(`<input type="hidden" name="${elemento.attr('name')}" value="${hiddenValue}">`);
                        }
                    }
                    
                    // Agregar estilo visual para campos bloqueados
                    if (!$('#estilos-bloqueados').length) {
                        $('head').append(`
                            <style id="estilos-bloqueados">
                                .campo-bloqueado {
                                    background-color: #f8f9fa !important;
                                    border-color: #dee2e6 !important;
                                    color: #6c757d !important;
                                    cursor: not-allowed !important;
                                }
                                .campo-bloqueado:focus {
                                    box-shadow: none !important;
                                }
                                select.campo-bloqueado {
                                    pointer-events: none !important;
                                }
                            </style>
                        `);
                    }
                } else {
                    elemento.prop('readonly', false);
                    elemento.prop('disabled', false);
                    elemento.removeClass('campo-bloqueado');
                    
                    // Remover campos hidden creados para selects
                    if (elemento.is('select')) {
                        $(`input[name="${elemento.attr('name')}"][type="hidden"]`).remove();
                    }
                }
            });
        }

        function actualizarEstadoCiudadano(esExistente, datos = null) {
            ciudadanoExistente = esExistente;
            const estadoBadge = $('#estado_ciudadano');
            const estadoTexto = $('#estado_texto');
            const alertaExistente = $('#alerta_ciudadano_existente');
            const btnLimpiar = $('#btn_limpiar_busqueda');

            if (esExistente && datos) {
                // Ciudadano existente
                estadoTexto.text('Ciudadano existente');
                estadoBadge.removeClass('bg-light text-dark').addClass('bg-success text-white').show();
                alertaExistente.slideDown();
                btnLimpiar.show();
                bloquearCamposCiudadano(true);
                
                // Mostrar mensaje de éxito
                mostrarMensaje(`Ciudadano encontrado: ${datos.nombre}`, "success");
            } else {
                // Ciudadano nuevo
                estadoTexto.text('Nuevo ciudadano');
                estadoBadge.removeClass('bg-success text-white').addClass('bg-warning text-dark').show();
                alertaExistente.slideUp();
                btnLimpiar.hide();
                bloquearCamposCiudadano(false);
            }
        }

        function limpiarBusquedaCiudadano() {
            // Limpiar todos los campos del ciudadano
            $('#numero_identificacion').val('');
            camposCiudadano.forEach(function(campo) {
                $(campo).val('');
            });
            $('#cuidadano_id').val('');
            
            // Restablecer estado
            actualizarEstadoCiudadano(false);
            
            // Enfocar en el campo de identificación
            $('#numero_identificacion').focus();
        }

        // ==================== FUNCIONALIDAD DEL BOTÓN ANÓNIMO ====================
        
        const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

        $('#btn_anonimo').on('click', function() {
            // Simplemente colocar el número anónimo y disparar la búsqueda
            $('#numero_identificacion').val(NUMERO_ANONIMO).trigger('change');
            $('#es_anonimo').prop('checked', true);
            // Limpiar posibles autocompletados
            $('#correo').val('');
            $('#telefono').val('');
            
            // Mostrar mensaje de confirmación breve
            Swal.fire({
                title: 'Cargando ciudadano anónimo...',
                icon: 'info',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        });

        // ==================== EVENTO PARA LIMPIAR BÚSQUEDA ====================
        
        $('#btn_limpiar_busqueda').on('click', function() {
            Swal.fire({
                title: '¿Limpiar búsqueda?',
                text: 'Se limpiará la información del ciudadano actual y podrá buscar otro.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, limpiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    limpiarBusquedaCiudadano();
                }
            });
        });

        // ==================== FUNCIONES PARA PREGUNTAS ADICIONALES ====================
        
        // Manejo de la pregunta "Se comunica de una URI"
        $('input[name="se_comunica_uri"]').on('change', function() {
            const valor = $(this).val();
            const ciudadContainer = $('#ciudad_municipio_container');
            const ciudadInput = $('#ciudad_municipio_uri');
            
            if (valor === '1') { // SÍ
                ciudadContainer.show().removeClass('d-none');
                ciudadInput.prop('required', true);
                ciudadContainer.hide().fadeIn(300);
            } else { // NO
                ciudadContainer.fadeOut(300, function() {
                    ciudadInput.prop('required', false).val('');
                });
            }
        });

        // Manejo de la pregunta "Consulta jurídica"
        $('input[name="consulta_juridica"]').on('change', function() {
            const valor = $(this).val();
            const abogadoContainer = $('#abogado_container');
            const abogadoSelect = $('#abogado');
            
            if (valor === '1') { // SÍ
                abogadoContainer.show().removeClass('d-none');
                abogadoSelect.prop('required', true);
                abogadoContainer.hide().fadeIn(300);
            } else { // NO
                abogadoContainer.fadeOut(300, function() {
                    abogadoSelect.prop('required', false).val('');
                });
            }
        });

        // ==================== CARGA INICIAL ====================
        
        // Cargar tipificaciones (son universales)
        $.ajax({
            url: '/api/tipificaciones/',
            method: 'GET',
            success: function(response) {
                limpiarSelect('#tipificacion', 'Seleccione una tipificación...');
                response.forEach(function(tip) {
                    $('#tipificacion').append(`<option value="${tip.id}">${tip.nombre}</option>`);
                });
            },
            error: function() {
                mostrarMensaje('Error al cargar tipificaciones');
            }
        });

        // ==================== BÚSQUEDA DE CIUDADANO ====================
        
        $('#numero_identificacion').on('change blur', function() {
            const numero = $(this).val().trim();
            
            if (!numero) {
                $('#cuidadano_id').val('');
                actualizarEstadoCiudadano(false);
                return;
            }
            
            // Mostrar indicador de carga
            $(this).prop('disabled', true);
            const estadoBadge = $('#estado_ciudadano');
            const estadoTexto = $('#estado_texto');
            estadoTexto.text('Buscando...');
            estadoBadge.removeClass().addClass('badge bg-info text-white').show();
            
            $.ajax({
                url: '/api/ciudadano/',
                method: 'GET',
                data: { numero_identificacion: numero },
                success: function(response) {
                    $('#numero_identificacion').prop('disabled', false);
                    
                    if (response && response.id) {
                        // Ciudadano encontrado - llenar datos y bloquear campos
                        $('#tipo_identificacion').val(response.tipo_identificacion_id);
                        $('#nombre').val(response.nombre);
                        $('#correo').val(response.correo || '');
                        $('#telefono').val(response.telefono || '');
                        $('#direccion_residencia').val(response.direccion_residencia || '');
                        $('#pais').val(response.pais_id || '');
                        $('#ciudad').val(response.ciudad || '');
                        $('#cuidadano_id').val(response.id);
                        
                        actualizarEstadoCiudadano(true, response);
                    } else {
                        // Ciudadano no encontrado - permitir ingreso
                        $('#cuidadano_id').val('');
                        actualizarEstadoCiudadano(false);
                    }

                    // Si es anónimo, limpiar contacto y aplicar reglas UI
                    if ($('#numero_identificacion').val().trim() === NUMERO_ANONIMO) {
                        $('#correo').val('');
                        $('#telefono').val('');
                        $('#es_anonimo').prop('checked', true);
                        applyAnonUI(); // definida más abajo
                    }
                },
                error: function(xhr) {
                    $('#numero_identificacion').prop('disabled', false);
                    $('#cuidadano_id').val('');
                    actualizarEstadoCiudadano(false);
                    
                    if (xhr.status === 404) {
                        mostrarMensaje('Ciudadano no encontrado. Puede proceder con el registro.', "info");
                    } else {
                        mostrarMensaje('Error al buscar ciudadano. Intente nuevamente.');
                    }
                }
            });
        });

        // ==================== JERARQUÍA DE TIPIFICACIÓN ====================
        
        // 1. Tipo Canal → Segmentos
        $('#tipo_canal').on('change', function() {
            const tipoCanal = $(this).val();
            
            if (!tipoCanal) return;

            limpiarSelect('#segmento', 'Cargando segmentos...');
            limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
            limpiarSelect('#categoria', 'Selecciona una categoría');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            mostrarContainer('segmento_ii_container', false);
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);

            $.ajax({
                url: '/api/segmentos/',
                method: 'GET',
                data: { tipo_canal_id: tipoCanal },
                success: function(response) {
                    limpiarSelect('#segmento', 'Seleccione un segmento...');
                    if (response.length > 0) {
                        response.forEach(function(seg) {
                            $('#segmento').append(`<option value="${seg.id}" data-tiene-segmento-ii="${seg.tiene_segmento_ii}">${seg.nombre}</option>`);
                        });
                    } else {
                        mostrarMensaje('El tipo de canal seleccionado no tiene segmentos disponibles.');
                    }
                },
                error: function() {
                    mostrarMensaje('Error al cargar segmentos.');
                }
            });
        });

        // 2. Segmento → Segmento II (condicional) - VERSIÓN CORREGIDA
        $('#segmento').on('change', function() {
            const segmentoId = $(this).val();
            const selectedOption = $(this).find('option:selected');
            const tieneSegmentoII = selectedOption.data('tiene-segmento-ii') === true || selectedOption.data('tiene-segmento-ii') === 'true';

            // LIMPIAR TODOS LOS CAMPOS DEPENDIENTES (incluyendo segmento_iii)
            limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
            limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');  // AGREGADO
            limpiarSelect('#categoria', 'Selecciona una categoría');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            
            mostrarContainer('segmento_ii_container', false);
            mostrarContainer('segmento_iii_container', false);  // AGREGADO
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);
            
            $('#segmento_ii').prop('required', false);
            $('#segmento_iii').prop('required', false);  // AGREGADO

            if (tieneSegmentoII) {
                mostrarContainer('segmento_ii_container', true);
                $('#segmento_ii').prop('required', true);

                $.ajax({
                    url: '/api/segmentos-ii/',
                    method: 'GET',
                    data: { segmento_id: segmentoId },
                    success: function(response) {
                        limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
                        if (response.length > 0) {
                            response.forEach(function(seg2) {
                                $('#segmento_ii').append(`<option value="${seg2.id}">${seg2.nombre}</option>`);
                            });
                        } else {
                            mostrarMensaje('El segmento seleccionado no tiene segmentos II disponibles.');
                        }
                    },
                    error: function() {
                        mostrarMensaje('Error al cargar segmentos II.');
                    }
                });
            } else {
                mostrarContainer('segmento_ii_container', false);
                $('#segmento_ii').prop('required', false);
            }
        });

        // REEMPLAZAR el evento change de #segmento_ii con esta versión completamente dinámica:

        // 3. Segmento II → Segmento III (completamente dinámico) - VERSIÓN FINAL
        $('#segmento_ii').on('change', function() {
            const segmentoIIId = $(this).val();

            // Limpiar Segmento III siempre que cambie Segmento II
            limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
            mostrarContainer('segmento_iii_container', false);
            $('#segmento_iii').prop('required', false);

            if (!segmentoIIId) {
                return;
            }

            console.log('Verificando si Segmento II requiere Segmento III:', segmentoIIId);

            // Hacer una llamada DINÁMICA para verificar si hay segmentos III disponibles
            $.ajax({
                url: '/api/segmentos-iii/',
                method: 'GET',
                data: { segmento_ii_id: segmentoIIId },
                success: function(response) {
                    if (response.length > 0) {
                        // HAY segmentos III disponibles - mostrar el campo
                        console.log(`Se encontraron ${response.length} opciones de Segmento III`);
                        
                        mostrarContainer('segmento_iii_container', true);
                        $('#segmento_iii').prop('required', true);

                        // Llenar el select con las opciones disponibles
                        limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
                        response.forEach(function(seg3) {
                            $('#segmento_iii').append(`<option value="${seg3.id}">${seg3.nombre}</option>`);
                        });
                        
                        // Mostrar mensaje informativo
                        Swal.fire({
                            title: 'Opciones adicionales disponibles',
                            text: `Se encontraron ${response.length} opciones de Segmento III.`,
                            icon: 'info',
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    } else {
                        // NO HAY segmentos III - continuar flujo normal
                        console.log('No se encontraron opciones de Segmento III - Continuando flujo normal');
                        mostrarContainer('segmento_iii_container', false);
                        $('#segmento_iii').prop('required', false);
                        
                        // Enfocar en el siguiente campo (tipificación)
                        setTimeout(() => {
                            $('#tipificacion').focus();
                        }, 300);
                    }
                },
                error: function(xhr) {
                    // Error en la consulta - asumir que no hay segmentos III
                    console.log('Error al consultar Segmentos III o no hay datos disponibles');
                    mostrarContainer('segmento_iii_container', false);
                    $('#segmento_iii').prop('required', false);
                    
                    // Continuar con el flujo normal
                    setTimeout(() => {
                        $('#tipificacion').focus();
                    }, 300);
                }
            });
        });

        // 4. Segmento III seleccionado → Continuar al siguiente paso
        $('#segmento_iii').on('change', function() {
            const segmentoIIITexto = $(this).find('option:selected').text();
            
            console.log('Segmento III seleccionado:', segmentoIIITexto);
            
            // Mostrar confirmación
            Swal.fire({
                title: 'Selección completada',
                text: `${segmentoIIITexto} seleccionado. Continúe con la tipificación.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
            
            // Enfocar en tipificación
            setTimeout(() => {
                $('#tipificacion').focus();
            }, 500);
        });

        // 3. Tipificación → Categorías
        $('#tipificacion').on('change', function() {
            const tipificacionId = $(this).val();

            if (!tipificacionId) return;

            limpiarSelect('#categoria', 'Cargando categorías...');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);
            mostrarContainer('otros_delitos_container', false);
            $('#cual_otro_delito').prop('required', false).val('');

            $.ajax({
                url: '/api/categorias/',
                method: 'GET',
                data: { tipificacion_id: tipificacionId },
                success: function(response) {
                    if (response.length > 0) {
                        // Tiene categorías - Funcionamiento normal
                        limpiarSelect('#categoria', 'Selecciona una categoría');
                        response.forEach(function(cat) {
                            $('#categoria').append(`<option value="${cat.id}">${cat.nombre}</option>`);
                        });
                        $('#categoria').prop('required', true);
                        $('#categoria_optional_label').hide();
                        $('#categoria_required_label').show();
                        
                        // Mostrar mensaje informativo
                        Swal.fire({
                            title: 'Categorías cargadas',
                            text: `Se encontraron ${response.length} categoría(s) disponibles.`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    } else {
                        // No tiene categorías - Tipificación directa
                        limpiarSelect('#categoria', 'Sin categorías - Tipificación directa');
                        $('#categoria').prop('required', false);
                        $('#categoria_optional_label').show();
                        $('#categoria_required_label').hide();
                        
                        // Agregar opción especial para tipificaciones sin categorías
                        $('#categoria').append(`<option value="0" selected>Sin categoría específica</option>`);
                        
                        // Mostrar mensaje informativo
                        Swal.fire({
                            title: 'Tipificación directa',
                            text: 'Esta tipificación no requiere selección de categoría.',
                            icon: 'info',
                            timer: 3000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    }
                },
                error: function() {
                    mostrarMensaje('Error al cargar categorías.');
                }
            });
        });

        // 4. Categoría → Subcategorías (condicional)
        $('#categoria').on('change', function() {
            const categoriaId = $(this).val();
            const categoriaTexto = $(this).find('option:selected').text().toUpperCase();

            if (!categoriaId) return;

            // Verificar si es "OTROS DELITOS" en CATEGORÍA
            const esOtrosDelitos = categoriaTexto.includes('OTROS DELITOS') || 
                                categoriaTexto.includes('OTRO DELITO') ||
                                categoriaTexto.includes('OTROS DELITO') ||
                                categoriaTexto.includes('OTRO DELITOS') ||
                                categoriaTexto.includes('OTRO') ||
                                categoriaTexto.includes('OTROS');

            if (esOtrosDelitos) {
                mostrarContainer('otros_delitos_container', true);
                $('#cual_otro_delito').prop('required', true);
            } else {
                // Solo ocultar si no hay subcategorías que lo puedan activar
                mostrarContainer('otros_delitos_container', false);
                $('#cual_otro_delito').prop('required', false).val('');
            }

            // Limpiar subcategorías y niveles superiores
            limpiarSelect('#subcategoria', 'Buscando subcategorías...');
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);
            $('#subcategoria').prop('required', false);

            $.ajax({
                url: '/api/subcategorias/',
                method: 'GET',
                data: { categoria_padre_id: categoriaId },
                success: function(response) {
                    if (response.length > 0) {
                        limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
                        response.forEach(function(sub) {
                            $('#subcategoria').append(`<option value="${sub.id}">${sub.nombre}</option>`);
                        });

                        // Mostrar el contenedor y hacer requerido
                        mostrarContainer('subcategoria_container', true);
                        $('#subcategoria').prop('required', true);
                    }
                },
                error: function() {
                    console.log('No hay subcategorías disponibles o error en la consulta');
                }
            });
        });

        // 5. Subcategoría → Verificar "OTROS DELITOS" y Sub Categoría II
        $('#subcategoria').on('change', function() {
            const subcategoriaId = $(this).val();
            const subcategoriaTexto = $(this).find('option:selected').text().toUpperCase();

            // Limpiar contenedores de niveles superiores
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);
            $('#subcategoria_ii').prop('required', false);
            $('#subcategoria_iii').prop('required', false);

            // Verificar si es "OTROS DELITOS" en SUBCATEGORÍA
            const esOtrosDelitos = subcategoriaTexto.includes('OTROS DELITOS') || 
                                subcategoriaTexto.includes('OTRO DELITO') ||
                                subcategoriaTexto.includes('OTROS DELITO') ||
                                subcategoriaTexto.includes('OTRO DELITOS') ||
                                subcategoriaTexto.includes('OTRO') ||
                                subcategoriaTexto.includes('OTROS');

            if (esOtrosDelitos) {
                mostrarContainer('otros_delitos_container', true);
                $('#cual_otro_delito').prop('required', true);
            } else {
                mostrarContainer('otros_delitos_container', false);
                $('#cual_otro_delito').prop('required', false).val('');
            }

            // NUEVA FUNCIONALIDAD: Verificar si es PSICOLOGÍA (ID 133)
            if (subcategoriaId === '1037' || subcategoriaId === '1068') { // PSICOLOGIA
                console.log('Subcategoría PSICOLOGIA detectada, cargando Sub Categorías II...');
                
                mostrarContainer('subcategoria_ii_container', true);
                $('#subcategoria_ii').prop('required', true);

                // Cargar Sub Categorías II para PSICOLOGIA
                $.ajax({
                    url: '/api/subcategorias-ii/',
                    method: 'GET',
                    data: { categoria_padre_id: subcategoriaId },
                    success: function(response) {
                        limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
                        if (response.length > 0) {
                            response.forEach(function(subII) {
                                $('#subcategoria_ii').append(`<option value="${subII.id}">${subII.nombre}</option>`);
                            });
                            
                            // Mostrar toast informativo
                            Swal.fire({
                                title: 'Sub Categorías II cargadas',
                                text: `Se encontraron ${response.length} opciones para Psicología.`,
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false,
                                toast: true,
                                position: 'top-end'
                            });
                        } else {
                            mostrarMensaje('No hay Sub Categorías II disponibles para Psicología.');
                        }
                    },
                    error: function() {
                        mostrarMensaje('Error al cargar Sub Categorías II.');
                    }
                });
            }
        });

        // 6. Sub Categoría II → Verificar si necesita Sub Categoría III
        $('#subcategoria_ii').on('change', function() {
            const subcategoriaIIId = $(this).val();
            const subcategoriaIITexto = $(this).find('option:selected').text().toUpperCase();

            // Limpiar Sub Categoría III
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            mostrarContainer('subcategoria_iii_container', false);
            $('#subcategoria_iii').prop('required', false);

            console.log('Sub Categoría II seleccionada:', subcategoriaIITexto, 'ID:', subcategoriaIIId);

            // Si es NNA, no necesita Sub Categoría III
            if (subcategoriaIITexto === 'NNA') {
                console.log('NNA seleccionado - No requiere Sub Categoría III');
                
                Swal.fire({
                    title: 'Flujo NNA',
                    text: 'Puede proceder directamente a observaciones.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
                
                // Enfocar en observaciones
                setTimeout(() => {
                    $('#observacion').focus();
                }, 500);
                
                return;
            }

            // Si es ADULTO, cargar Sub Categoría III
            if (subcategoriaIITexto === 'ADULTO') {
                console.log('ADULTO seleccionado - Cargando Sub Categorías III...');
                
                mostrarContainer('subcategoria_iii_container', true);
                $('#subcategoria_iii').prop('required', true);

                // Cargar Sub Categorías III para ADULTO
                $.ajax({
                    url: '/api/subcategorias-iii/',
                    method: 'GET',
                    data: { categoria_padre_id: subcategoriaIIId },
                    success: function(response) {
                        limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
                        if (response.length > 0) {
                            response.forEach(function(subIII) {
                                $('#subcategoria_iii').append(`<option value="${subIII.id}">${subIII.nombre}</option>`);
                            });
                            
                            // Mostrar toast informativo
                            Swal.fire({
                                title: 'Sub Categorías III cargadas',
                                text: `Se encontraron ${response.length} opciones para Adulto.`,
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false,
                                toast: true,
                                position: 'top-end'
                            });
                        } else {
                            mostrarMensaje('No hay Sub Categorías III disponibles para Adulto.');
                        }
                    },
                    error: function() {
                        mostrarMensaje('Error al cargar Sub Categorías III.');
                    }
                });
            }
        });

        // 7. Sub Categoría III → Enfocar en observaciones
        $('#subcategoria_iii').on('change', function() {
            const subcategoriaIIITexto = $(this).find('option:selected').text();
            
            console.log('Sub Categoría III seleccionada:', subcategoriaIIITexto);
            
            // Mostrar confirmación y enfocar en observaciones
            Swal.fire({
                title: 'Flujo completado',
                text: `${subcategoriaIIITexto} seleccionado. Puede proceder a observaciones.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
            
            // Enfocar en observaciones
            setTimeout(() => {
                $('#observacion').focus();
            }, 500);
        });

        // ==================== VALIDACIÓN DEL FORMULARIO ====================
        
        $('form').on('submit', function(e) {
            console.log('Iniciando validación del formulario...');
            
            // Verificar que todos los campos requeridos estén llenos
            const tipoCanal = $('#tipo_canal').val();
            const segmento = $('#segmento').val();
            const tipificacion = $('#tipificacion').val();
            const categoria = $('#categoria').val();
            const categoriaEsRequerida = $('#categoria').prop('required');
            
            if (!tipoCanal || !segmento || !tipificacion) {
                e.preventDefault();
                mostrarMensaje('Por favor complete los campos de tipificación requeridos.');
                return false;
            }

            // Solo validar categoría si es requerida
            if (categoriaEsRequerida && !categoria) {
                e.preventDefault();
                mostrarMensaje('Por favor seleccione una categoría.');
                return false;
            }

            // Verificar Segmento II si es requerido
            const segmentoIIContainer = $('#segmento_ii_container');
            if (segmentoIIContainer.is(':visible') && $('#segmento_ii').prop('required')) {
                const segmentoII = $('#segmento_ii').val();
                if (!segmentoII) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione un Segmento II.');
                    return false;
                }
            }

            // Verificar Subcategoría si es requerida
            const subcategoriaContainer = $('#subcategoria_container');
            if (subcategoriaContainer.is(':visible') && $('#subcategoria').prop('required')) {
                const subcategoria = $('#subcategoria').val();
                if (!subcategoria) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione una subcategoría.');
                    return false;
                }
            }

            // NUEVAS VALIDACIONES para Sub Categorías II y III
            
            // Verificar Sub Categoría II si es requerida
            const subcategoriaIIContainer = $('#subcategoria_ii_container');
            if (subcategoriaIIContainer.is(':visible') && $('#subcategoria_ii').prop('required')) {
                const subcategoriaII = $('#subcategoria_ii').val();
                if (!subcategoriaII) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione una Sub Categoría II.');
                    $('#subcategoria_ii').focus();
                    return false;
                }
            }

            // Verificar Sub Categoría III si es requerida
            const subcategoriaIIIContainer = $('#subcategoria_iii_container');
            if (subcategoriaIIIContainer.is(':visible') && $('#subcategoria_iii').prop('required')) {
                const subcategoriaIII = $('#subcategoria_iii').val();
                if (!subcategoriaIII) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione una Sub Categoría III.');
                    $('#subcategoria_iii').focus();
                    return false;
                }
            }

            // Verificar campo "¿Cuál otro delito?" si es requerido
            const otrosDelitosContainer = $('#otros_delitos_container');
            if (otrosDelitosContainer.is(':visible') && $('#cual_otro_delito').prop('required')) {
                const cualOtroDelito = $('#cual_otro_delito').val().trim();
                if (!cualOtroDelito) {
                    e.preventDefault();
                    mostrarMensaje('Por favor especifique cuál es el otro delito.');
                    $('#cual_otro_delito').focus();
                    return false;
                }
            }

            // ==================== VALIDACIONES PARA PREGUNTAS ADICIONALES ====================
            
            // Verificar campo Ciudad/Municipio si "Se comunica de una URI" es SÍ
            const uriSeleccionada = $('input[name="se_comunica_uri"]:checked').val();
            if (uriSeleccionada === '1') {
                const ciudadMunicipio = $('#ciudad_municipio_uri').val().trim();
                if (!ciudadMunicipio) {
                    e.preventDefault();
                    mostrarMensaje('Por favor indique la ciudad/municipio de la URI.');
                    $('#ciudad_municipio_uri').focus();
                    return false;
                }
            }

            // Verificar campo Abogado si "Consulta jurídica" es SÍ
            const consultaJuridica = $('input[name="consulta_juridica"]:checked').val();
            if (consultaJuridica === '1') {
                const abogado = $('#abogado').val();
                if (!abogado) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione un abogado para la consulta jurídica.');
                    $('#abogado').focus();
                    return false;
                }
            }

            // ==================== VALIDACIÓN ESPECIAL PARA CIUDADANO EXISTENTE ====================
            
            if (ciudadanoExistente) {
                console.log('Procesando ciudadano existente...');
                
                // Verificar que el ID del ciudadano esté presente
                const ciudadanoId = $('#cuidadano_id').val();
                if (!ciudadanoId) {
                    e.preventDefault();
                    mostrarMensaje('Error: ID de ciudadano no encontrado. Busque nuevamente el ciudadano.');
                    $('#numero_identificacion').focus();
                    return false;
                }

                // Asegurar que los campos requeridos del ciudadano tengan valor
                const numeroId = $('#numero_identificacion').val();
                const tipoId = $('#tipo_identificacion').val();
                const nombre = $('#nombre').val();
                
                if (!numeroId || !tipoId || !nombre) {
                    e.preventDefault();
                    mostrarMensaje('Error en los datos del ciudadano. Por favor, busque nuevamente.');
                    $('#numero_identificacion').focus();
                    return false;
                }

                // Temporalmente habilitar campos para envío si están deshabilitados
                $('.campo-bloqueado').each(function() {
                    if ($(this).is('select') && $(this).prop('disabled')) {
                        $(this).prop('disabled', false);
                        $(this).addClass('temp-enabled-for-submit');
                    }
                });

                console.log('Ciudadano existente validado correctamente');
            } else {
                console.log('Procesando ciudadano nuevo...');
                
                // Para ciudadano nuevo, validar campos requeridos básicos
                const numeroId = $('#numero_identificacion').val();
                const tipoId = $('#tipo_identificacion').val();
                const nombre = $('#nombre').val();
                
                if (!numeroId || !tipoId || !nombre) {
                    e.preventDefault();
                    mostrarMensaje('Por favor complete los datos básicos del ciudadano (Número ID, Tipo ID, Nombre).');
                    return false;
                }
            }

            // Log para debug
            console.log('Datos a enviar:', {
                ciudadano_existente: ciudadanoExistente,
                ciudadano_id: $('#cuidadano_id').val(),
                numero_identificacion: $('#numero_identificacion').val(),
                tipo_identificacion: $('#tipo_identificacion').val(),
                nombre: $('#nombre').val()
            });

            console.log('Validación completada exitosamente (incluyendo Sub Categorías II y III)');
            return true;
        });

        // ==================== DESPUÉS DEL ENVÍO ====================
        
        // Si el formulario se envía exitosamente, restaurar estados
        $('form').on('submit', function() {
            // Usar un pequeño delay para permitir que el envío se complete
            setTimeout(function() {
                $('.temp-enabled-for-submit').each(function() {
                    $(this).prop('disabled', true);
                    $(this).removeClass('temp-enabled-for-submit');
                });
            }, 100);
        });

        // ==================== LIMPIAR FORMULARIO (RESET) MEJORADO ====================
        
        function limpiarFormularioCompleto() {
            // Limpiar campos de ciudadano
            limpiarBusquedaCiudadano();
            
            // Limpiar campos adicionales existentes
            $('input[name="se_comunica_uri"]').prop('checked', false);
            $('input[name="consulta_juridica"]').prop('checked', false);
            $('#ciudad_municipio_container').hide();
            $('#abogado_container').hide();
            $('#ciudad_municipio_uri').prop('required', false).val('');
            $('#abogado').prop('required', false).val('');
            
            // NUEVO: Limpiar Sub Categorías II y III
            mostrarContainer('subcategoria_ii_container', false);
            mostrarContainer('subcategoria_iii_container', false);
            limpiarSelect('#subcategoria_ii', 'Selecciona una sub categoría II');
            limpiarSelect('#subcategoria_iii', 'Selecciona una sub categoría III');
            $('#subcategoria_ii').prop('required', false);
            $('#subcategoria_iii').prop('required', false);
            
            // Limpiar otros contenedores condicionales
            mostrarContainer('segmento_ii_container', false);
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('otros_delitos_container', false);
            
            // Limpiar selects de tipificación
            limpiarSelect('#tipo_canal', 'Seleccione un tipo de canal...');
            limpiarSelect('#segmento', 'Seleccione un segmento...');
            limpiarSelect('#categoria', 'Selecciona una categoría');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            
            // Limpiar otros campos
            $('#conversacion_id').val('');
            $('#observacion').val('');
            $('#cual_otro_delito').val('');
        }

        $('#btn_limpiar, button[type="reset"]').on('click', function(e) {
            e.preventDefault();
            
            Swal.fire({
                title: '¿Limpiar formulario?',
                text: 'Se perderán todos los datos ingresados incluyendo las sub categorías.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, limpiar todo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    limpiarFormularioCompleto();
                    mostrarMensaje('Formulario limpiado correctamente.', 'success');
                }
            });
        });

        // ==================== EVENTOS ADICIONALES ====================
        
        // Prevenir edición de campos bloqueados mediante teclado
        $(document).on('keydown', '.campo-bloqueado', function(e) {
            // Permitir teclas de navegación
            const teclasPermitidas = [9, 16, 17, 18, 27, 37, 38, 39, 40]; // Tab, Shift, Ctrl, Alt, Esc, flechas
            if (teclasPermitidas.includes(e.keyCode)) {
                return true;
            }
            e.preventDefault();
            return false;
        });

        // Prevenir cambios en selects bloqueados
        $(document).on('mousedown', 'select.campo-bloqueado', function(e) {
            e.preventDefault();
            return false;
        });

        // Mostrar tooltip en campos bloqueados
        $(document).on('mouseenter', '.campo-bloqueado', function() {
            $(this).attr('title', 'Campo bloqueado - Ciudadano existente');
        });

        // Validación en tiempo real del ID de conversación
        $('#conversacion_id').on('input', function() {
            const valor = $(this).val();
            const esValido = valor.length >= 5;
            
            $(this).toggleClass('is-invalid', !esValido && valor.length > 0);
            $(this).toggleClass('is-valid', esValido);
        });

        // ==================== INICIALIZACIÓN ====================
        
        // Establecer foco inicial
        $('#numero_identificacion').focus();
        
        // Inicializar estado
        actualizarEstadoCiudadano(false);
        
        console.log('Tipificador inicializado correctamente con Sub Categorías II y III');
    });
</script>

<!-- Script adicional: lógica de “Anónimo” por rol (no interfiere con lo anterior) -->
<script>
(function(){
  const IS_SUPERVISOR = {% if is_supervisor %}true{% else %}false{% endif %};
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  const $chkAnon   = $('#es_anonimo');
  const $numId     = $('#numero_identificacion');
  const $correo    = $('#correo');
  const $tel       = $('#telefono');
  const $inconcer  = $('#telefono_inconcer');
  const $wrapIncon = $('#wrap_telefono_inconcer');

  const CAMPOS_BLOQUEAR = [
    '#tipo_identificacion', '#nombre',
    '#direccion_residencia', '#pais', '#ciudad'
  ];

  function setDisabled(selOrArr, val){
    const list = Array.isArray(selOrArr) ? selOrArr : [selOrArr];
    list.forEach(sel => {
      const $el = $(sel);
      if (!$el.length) return;
      $el.prop('disabled', val).prop('readonly', val);
      if (val) { $el.addClass('campo-bloqueado'); } else { $el.removeClass('campo-bloqueado'); }
      if ($el.is('select') && val){
        // no enviamos estos campos cuando es anónimo
      }
    });
  }

  function syncAnonFlag(){
    const anon = ($numId.val().trim() === NUMERO_ANONIMO) || $chkAnon.is(':checked');
    $chkAnon.prop('checked', anon);
    return anon;
  }

  // Expuesta para ser llamada desde AJAX success anterior
  window.applyAnonUI = function applyAnonUI(){
    if (IS_SUPERVISOR){
      $wrapIncon.hide();
      return;
    }
    const anon = syncAnonFlag();

    setDisabled(CAMPOS_BLOQUEAR, anon);

    // Correo/Teléfono siempre habilitados; si es anónimo, actúan como contacto
    setDisabled([$correo, $tel], false);

    $wrapIncon.show();
    setDisabled($inconcer, false);

    if (anon){
        // Solo para anónimos: cambiar placeholder del correo
        $correo.attr('placeholder','Correo de contacto (anónimo)');
        $tel.attr('placeholder','Teléfono del que se comunica (anónimo)');
        $inconcer.attr('placeholder','Teléfono Inconcer (anónimo)');
    } else {
        // Para ciudadanos normales: placeholders normales
        $correo.attr('placeholder',''); // Correo normal
        $tel.attr('placeholder','Teléfono del que se comunica');
        $inconcer.attr('placeholder','Teléfono que llega desde Inconcer');
    }
  };

  // Botón ya setea el número anónimo; aquí solo aplicamos reglas al cambiar doc
  $numId.on('input change blur', function(){
    applyAnonUI();
  });

  // Primera aplicación
  applyAnonUI();
})();
</script>

{% endblock %}

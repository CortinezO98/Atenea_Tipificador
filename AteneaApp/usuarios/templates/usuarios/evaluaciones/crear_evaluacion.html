{% extends "usuarios/base/base.html" %}
{% load static %}
{% block title %}Crear Evaluación{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <form method="post">
        {% csrf_token %}
        <!-- Flag anónimo que viaja al backend -->
        <input type="checkbox" name="es_anonimo" id="es_anonimo" value="1" class="d-none">

        <!-- Tarjeta de Datos Básicos -->
        <div class="card shadow mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="h5 mb-0"><i class="bi bi-person-badge me-2"></i>Datos del Ciudadano</h3>
            <!-- Indicador de estado -->
            <span id="estado_ciudadano" class="badge bg-light text-dark" style="display:none;">
              <i class="bi bi-info-circle me-1"></i>
              <span id="estado_texto">Nuevo ciudadano</span>
            </span>
          </div>
          <div class="card-body">
            <!-- Alerta informativa -->
            <div id="alerta_ciudadano_existente" class="alert alert-info alert-dismissible" style="display:none;">
              <i class="bi bi-info-circle-fill me-2"></i>
              <strong>Ciudadano encontrado:</strong> Los datos están bloqueados para edición.
              Solo se puede modificar el número de identificación para buscar otro ciudadano.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="numero_identificacion" class="form-label">
                  <i class="bi bi-123 me-1"></i>Número de Identificación
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="text" name="numero_identificacion" id="numero_identificacion"
                         class="form-control" maxlength="20" required>
                  <button type="button" id="btn_anonimo" class="btn btn-outline-info" title="Cargar ciudadano anónimo">
                    <i class="bi bi-person-fill-x me-1"></i>Anónimo
                  </button>
                  <button type="button" id="btn_limpiar_busqueda" class="btn btn-outline-secondary"
                          style="display:none;" title="Limpiar búsqueda">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                <small class="text-muted">Ingrese el número para buscar ciudadano existente</small>
              </div>

              <div class="col-md-6">
                <label for="tipo_identificacion" class="form-label">
                  <i class="bi bi-card-checklist me-1"></i>Tipo de Identificación
                  <span class="text-danger">*</span>
                </label>
                <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" required>
                  <option value="" selected disabled>Seleccionar...</option>
                  {% for tipo in tiposIdentificacion %}
                    <option value="{{tipo.id}}">{{tipo.nombre}}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label for="nombre" class="form-label">
                  <i class="bi bi-person-circle me-1"></i>Nombre Completo
                  <span class="text-danger">*</span>
                </label>
                <input type="text" name="nombre" id="nombre" class="form-control" maxlength="255" required>
              </div>

              <div class="col-md-6">
                <label for="conversacion_id" class="form-label">
                  <i class="bi bi-chat-dots me-1"></i>ID Conversación
                  <span class="text-danger">*</span>
                </label>
                <input type="text" name="conversacion_id" id="conversacion_id" class="form-control" maxlength="250" required>
                <div class="invalid-feedback">Ingrese un ID de conversación válido (mín. 5 caracteres)</div>
              </div>

              <!-- Correo -->
              <div class="col-md-6">
                <label for="correo" class="form-label">
                  <i class="bi bi-envelope me-1"></i>Correo electrónico
                </label>
                <input type="email" name="correo" id="correo" class="form-control" maxlength="254">
              </div>

              <!-- Teléfono -->
              <div class="col-md-6">
                <label for="telefono" class="form-label">
                  <i class="bi bi-telephone me-1"></i>Teléfono del que se comunica
                </label>
                <input type="text" name="telefono" id="telefono" class="form-control" maxlength="20">
              </div>

              <!-- NUEVO: Teléfono Inconcer (solo visible en Anónimo para Agente) -->
              <div class="col-md-6" id="wrap_telefono_inconcer" style="display:none;">
                <label for="telefono_inconcer" class="form-label">
                  <i class="bi bi-telephone-inbound me-1"></i>Teléfono Inconcer
                </label>
                <input type="text" name="telefono_inconcer" id="telefono_inconcer"
                       class="form-control" maxlength="20" placeholder="Teléfono que llega desde Inconcer">
              </div>

              <!-- Dirección -->
              <div class="col-md-6">
                <label for="direccion_residencia" class="form-label">
                  <i class="bi bi-geo-alt me-1"></i>Dirección de residencia
                </label>
                <input type="text" name="direccion_residencia" id="direccion_residencia" class="form-control" maxlength="255">
              </div>

              <!-- País -->
              <div class="col-md-6">
                <label for="pais" class="form-label">
                  <i class="bi bi-globe me-1"></i>País
                </label>
                <select name="pais" id="pais" class="form-select">
                  <option value="" disabled selected>Seleccionar país...</option>
                  {% for p in paises %}
                    <option value="{{ p.id }}">{{ p.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Ciudad -->
              <div class="col-md-6">
                <label for="ciudad" class="form-label">
                  <i class="bi bi-building me-1"></i>Ciudad
                </label>
                <input type="text" name="ciudad" id="ciudad" class="form-control" maxlength="100">
              </div>

              <input type="text" name="cuidadano_id" id="cuidadano_id" value="" hidden>
            </div>
          </div>
        </div>

        <!-- Tarjeta de Tipificación -->
        <div class="card shadow mb-4">
          <div class="card-header bg-info text-white">
            <h3 class="h5 mb-0"><i class="bi bi-diagram-3 me-2"></i>Proceso de Tipificación</h3>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Tipo de Canal -->
              <div class="col-md-6">
                <label for="tipo_canal" class="form-label">
                  <i class="bi bi-broadcast me-1"></i>Tipo de Canal
                  <span class="text-danger">*</span>
                </label>
                <select name="tipo_canal" id="tipo_canal" class="form-select" required>
                  <option value="" selected disabled>Seleccione un tipo de canal...</option>
                  {% for tipo in tipos_canal %}
                    <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Segmento -->
              <div class="col-md-6">
                <label for="segmento" class="form-label">
                  <i class="bi bi-diagram-2 me-1"></i>Segmento
                  <span class="text-danger">*</span>
                </label>
                <select name="segmento" id="segmento" class="form-select" required>
                  <option value="" selected disabled>Seleccione un segmento...</option>
                </select>
              </div>

              <!-- Segmento II (condicional) -->
              <div class="col-md-6" id="segmento_ii_container" style="display:none;">
                <label for="segmento_ii" class="form-label">
                  <i class="bi bi-diagram-3 me-1"></i>Segmento II
                  <span class="text-danger">*</span>
                </label>
                <select name="segmento_ii" id="segmento_ii" class="form-select">
                  <option value="" selected disabled>Seleccione un segmento II...</option>
                </select>
              </div>

              <!-- Segmento III (condicional) -->
              <div class="col-md-6" id="segmento_iii_container" style="display:none;">
                <label for="segmento_iii" class="form-label">
                  <i class="bi bi-diagram-3-fill me-1"></i>Segmento III
                  <span class="text-danger">*</span>
                </label>
                <select name="segmento_iii" id="segmento_iii" class="form-select">
                  <option value="" selected disabled>Seleccione un segmento III...</option>
                </select>
              </div>

              <!-- Tipificación -->
              <div class="col-md-6">
                <label for="tipificacion" class="form-label">
                  <i class="bi bi-tag me-1"></i>Tipificación
                  <span class="text-danger">*</span>
                </label>
                <select name="tipificacion" id="tipificacion" class="form-select" required>
                  <option value="" selected disabled>Seleccione una tipificación...</option>
                </select>
              </div>

              <!-- Categoría (Nivel 1) -->
              <div class="col-md-6">
                <label for="categoria" class="form-label">
                  <i class="bi bi-menu-button me-1"></i>Categoría
                  <span class="text-muted small" id="categoria_optional_label" style="display:none;">(Opcional)</span>
                  <span class="text-danger" id="categoria_required_label">*</span>
                </label>
                <select name="categoria" id="categoria" class="form-select" required>
                  <option value="" selected disabled>Selecciona una categoría</option>
                </select>
              </div>

              <!-- Subcategoría (Nivel 2) -->
              <div class="col-md-6" id="subcategoria_container" style="display:none;">
                <label for="subcategoria" class="form-label">
                  <i class="bi bi-menu-button-wide me-1"></i>Sub Categoría
                  <span class="text-danger">*</span>
                </label>
                <select name="subcategoria" id="subcategoria" class="form-select">
                  <option value="" selected disabled>Selecciona una sub categoría</option>
                </select>
              </div>

              <!-- Sub Categoría II (Nivel 3) -->
              <div class="col-md-6" id="subcategoria_ii_container" style="display:none;">
                <label for="subcategoria_ii" class="form-label">
                  <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría II
                  <span class="text-danger">*</span>
                </label>
                <select name="subcategoria_ii" id="subcategoria_ii" class="form-select">
                  <option value="" selected disabled>Selecciona una sub categoría II</option>
                </select>
              </div>

              <!-- Sub Categoría III (Nivel 4) -->
              <div class="col-md-6" id="subcategoria_iii_container" style="display:none;">
                <label for="subcategoria_iii" class="form-label">
                  <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría III
                  <span class="text-danger">*</span>
                </label>
                <select name="subcategoria_iii" id="subcategoria_iii" class="form-select">
                  <option value="" selected disabled>Selecciona una sub categoría III</option>
                </select>
              </div>

              <!-- Sub Categoría IV (Nivel 5) -->
              <div class="col-md-6" id="subcategoria_iv_container" style="display:none;">
                <label for="subcategoria_iv" class="form-label">
                  <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría IV
                  <span class="text-danger">*</span>
                </label>
                <select name="subcategoria_iv" id="subcategoria_iv" class="form-select">
                  <option value="" selected disabled>Selecciona una sub categoría IV</option>
                </select>
              </div>

              <!-- Sub Categoría V (Nivel 6) -->
              <div class="col-md-6" id="subcategoria_v_container" style="display:none;">
                <label for="subcategoria_v" class="form-label">
                  <i class="bi bi-menu-button-wide-fill me-1"></i>Sub Categoría V
                  <span class="text-danger">*</span>
                </label>
                <select name="subcategoria_v" id="subcategoria_v" class="form-select">
                  <option value="" selected disabled>Selecciona una sub categoría V</option>
                </select>
              </div>

              <!-- Observaciones -->
              <div class="col-12">
                <label for="observacion" class="form-label">
                  <i class="bi bi-chat-text me-1"></i>Observaciones
                  <span class="text-danger">*</span>
                </label>
                <textarea name="observacion" id="observacion" class="form-control" rows="3"
                          placeholder="Observaciones generales" required></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-4">
          <a href="{% url 'index' %}" class="btn btn-outline-secondary mx-2">Cancelar</a>
          <button type="reset" class="btn btn-secondary mx-2" id="btn_limpiar">
            <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Campos
          </button>
          <button type="submit" class="btn btn-primary mx-2" >
            <i class="bi bi-save me-2"></i>Guardar Evaluación
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  // ==================== VARIABLES GLOBALES ====================
  let ciudadanoExistente = false;
  const camposCiudadano = [
    '#tipo_identificacion', '#nombre', '#correo', '#telefono',
    '#direccion_residencia', '#pais', '#ciudad'
  ];

  // Mapa dinámico de niveles de categorías hasta 6
  // nivel: {container, select, endpoint}
  const nivelesCategorias = {
    1: { sel: '#categoria',        cont: null,                         endpoint: '/api/categorias/' },
    2: { sel: '#subcategoria',     cont: '#subcategoria_container',    endpoint: '/api/subcategorias/' },
    3: { sel: '#subcategoria_ii',  cont: '#subcategoria_ii_container', endpoint: '/api/subcategorias-ii/' },
    4: { sel: '#subcategoria_iii', cont: '#subcategoria_iii_container',endpoint: '/api/subcategorias-iii/' },
    5: { sel: '#subcategoria_iv',  cont: '#subcategoria_iv_container', endpoint: '/api/subcategorias-iv/' }, // opcional
    6: { sel: '#subcategoria_v',   cont: '#subcategoria_v_container',  endpoint: '/api/subcategorias-v/' }   // opcional
  };

  // ==================== AUXILIARES ====================
  function mostrarMensaje(mensaje, tipo = "warning") {
    Swal.fire({
      text: mensaje,
      icon: tipo,
      timer: tipo === "success" ? 3000 : undefined,
      showConfirmButton: tipo !== "success"
    });
  }

  function limpiarSelect(selector, placeholder) {
    $(selector).empty().append(`<option value="" disabled selected>${placeholder}</option>`);
  }

  function toggleContainer(containerId, show = true) {
    if (!containerId) return;
    const $c = $(containerId);
    if (show) {
      $c.show().removeClass('d-none');
    } else {
      $c.hide().addClass('d-none');
      $c.find('select, input').prop('required', false);
    }
  }

  function isOtrosDelitosLabel(texto) {
    const t = (texto || '').toUpperCase();
    return t.includes('OTROS DELITOS') || t.includes('OTRO DELITO') || t.includes('OTROS DELITO')
        || t.includes('OTRO DELITOS') || t === 'OTRO' || t === 'OTROS';
  }

  // ==================== BLOQUEO DE CAMPOS ====================
  function bloquearCamposCiudadano(bloquear = true) {
    camposCiudadano.forEach(function (campo) {
      const $el = $(campo);
      if (bloquear) {
        $el.prop('readonly', true).addClass('campo-bloqueado');
        if ($el.is('select')) {
          $el.prop('disabled', true);
          const hiddenName = $el.attr('name') + '_hidden';
          const hiddenValue = $el.val();
          $(`input[name="${hiddenName}"]`).remove();
          if (hiddenValue) {
            $el.after(`<input type="hidden" name="${$el.attr('name')}" value="${hiddenValue}">`);
          }
        }
        if (!$('#estilos-bloqueados').length) {
          $('head').append(`
            <style id="estilos-bloqueados">
              .campo-bloqueado{background-color:#f8f9fa!important;border-color:#dee2e6!important;color:#6c757d!important;cursor:not-allowed!important}
              .campo-bloqueado:focus{box-shadow:none!important}
              select.campo-bloqueado{pointer-events:none!important}
            </style>
          `);
        }
      } else {
        $el.prop('readonly', false).prop('disabled', false).removeClass('campo-bloqueado');
        if ($el.is('select')) {
          $(`input[name="${$el.attr('name')}"][type="hidden"]`).remove();
        }
      }
    });
  }

  function actualizarEstadoCiudadano(esExistente, datos = null) {
    ciudadanoExistente = esExistente;
    const $estado = $('#estado_ciudadano');
    const $texto  = $('#estado_texto');
    const $alerta = $('#alerta_ciudadano_existente');
    const $btnL   = $('#btn_limpiar_busqueda');

    if (esExistente && datos) {
      $texto.text('Ciudadano existente');
      $estado.removeClass('bg-light text-dark').addClass('bg-success text-white').show();
      $alerta.slideDown();
      $btnL.show();
      bloquearCamposCiudadano(true);
      mostrarMensaje(`Ciudadano encontrado: ${datos.nombre}`, 'success');
    } else {
      $texto.text('Nuevo ciudadano');
      $estado.removeClass('bg-success text-white').addClass('bg-warning text-dark').show();
      $alerta.slideUp();
      $btnL.hide();
      bloquearCamposCiudadano(false);
    }
  }

  function limpiarBusquedaCiudadano() {
    $('#numero_identificacion').val('');
    camposCiudadano.forEach(c => $(c).val(''));
    $('#cuidadano_id').val('');
    actualizarEstadoCiudadano(false);
    $('#numero_identificacion').focus();
  }

  // ==================== ANÓNIMO ====================
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  $('#btn_anonimo').on('click', function () {
    $('#numero_identificacion').val(NUMERO_ANONIMO).trigger('change');
    $('#es_anonimo').prop('checked', true);
    $('#correo').val('');
    $('#telefono').val('');
    Swal.fire({
      title: 'Cargando ciudadano anónimo...',
      icon: 'info',
      timer: 1500,
      showConfirmButton: false,
      toast: true,
      position: 'top-end'
    });
  });

  $('#btn_limpiar_busqueda').on('click', function () {
    Swal.fire({
      title: '¿Limpiar búsqueda?',
      text: 'Se limpiará la información del ciudadano actual y podrá buscar otro.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar',
      cancelButtonText: 'Cancelar'
    }).then((r) => { if (r.isConfirmed) limpiarBusquedaCiudadano(); });
  });

  // ==================== PREGUNTAS ADICIONALES ====================
  $('input[name="se_comunica_uri"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#ciudad_municipio_container');
    const $inp  = $('#ciudad_municipio_uri');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $inp.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $inp.prop('required', false).val('');
      });
    }
  });

  $('input[name="consulta_juridica"]').on('change', function () {
    const si = $(this).val() === '1';
    const $cont = $('#abogado_container');
    const $sel  = $('#abogado');
    if (si) {
      $cont.show().removeClass('d-none').hide().fadeIn(300);
      $sel.prop('required', true);
    } else {
      $cont.fadeOut(300, function () {
        $sel.prop('required', false).val('');
      });
    }
  });

  // ==================== CARGA INICIAL ====================
  $.ajax({
    url: '/api/tipificaciones/',
    method: 'GET',
    success: function (response) {
      limpiarSelect('#tipificacion', 'Seleccione una tipificación...');
      response.forEach(t => $('#tipificacion').append(`<option value="${t.id}">${t.nombre}</option>`));
    },
    error: function () { mostrarMensaje('Error al cargar tipificaciones'); }
  });

  // ==================== BÚSQUEDA DE CIUDADANO ====================
  $('#numero_identificacion').on('change blur', function () {
    const numero = $(this).val().trim();
    if (!numero) { $('#cuidadano_id').val(''); actualizarEstadoCiudadano(false); return; }

    $(this).prop('disabled', true);
    const $badge = $('#estado_ciudadano');
    const $txt   = $('#estado_texto');
    $txt.text('Buscando...');
    $badge.removeClass().addClass('badge bg-info text-white').show();

    $.ajax({
      url: '/api/ciudadano/',
      method: 'GET',
      data: { numero_identificacion: numero },
      success: function (r) {
        $('#numero_identificacion').prop('disabled', false);
        if (r && r.id) {
          $('#tipo_identificacion').val(r.tipo_identificacion_id);
          $('#nombre').val(r.nombre);
          $('#correo').val(r.correo || '');
          $('#telefono').val(r.telefono || '');
          $('#direccion_residencia').val(r.direccion_residencia || '');
          $('#pais').val(r.pais_id || '');
          $('#ciudad').val(r.ciudad || '');
          $('#cuidadano_id').val(r.id);
          actualizarEstadoCiudadano(true, r);
        } else {
          $('#cuidadano_id').val('');
          actualizarEstadoCiudadano(false);
        }
        if ($('#numero_identificacion').val().trim() === NUMERO_ANONIMO) {
          $('#correo').val(''); $('#telefono').val('');
          $('#es_anonimo').prop('checked', true);
          applyAnonUI(); // definida en el script adicional
        }
      },
      error: function (xhr) {
        $('#numero_identificacion').prop('disabled', false);
        $('#cuidadano_id').val('');
        actualizarEstadoCiudadano(false);
        if (xhr.status === 404) {
          mostrarMensaje('Ciudadano no encontrado. Puede proceder con el registro.', 'info');
        } else {
          mostrarMensaje('Error al buscar ciudadano. Intente nuevamente.');
        }
      }
    });
  });

  // ==================== JERARQUÍA DE SEGMENTOS ====================
  $('#tipo_canal').on('change', function () {
    const tipoCanal = $(this).val();
    if (!tipoCanal) return;

    limpiarSelect('#segmento', 'Cargando segmentos...');
    limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
    limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
    toggleContainer('#segmento_ii_container', false);
    toggleContainer('#segmento_iii_container', false);

    // Limpiar categorías al cambiar canal
    resetCategoriasDesdeNivel(1);

    $.ajax({
      url: '/api/segmentos/',
      method: 'GET',
      data: { tipo_canal_id: tipoCanal },
      success: function (response) {
        limpiarSelect('#segmento', 'Seleccione un segmento...');
        if (response.length > 0) {
          response.forEach(seg => {
            $('#segmento').append(
              `<option value="${seg.id}" data-tiene-segmento-ii="${seg.tiene_segmento_ii}">${seg.nombre}</option>`
            );
          });
        } else {
          mostrarMensaje('El tipo de canal seleccionado no tiene segmentos disponibles.');
        }
      },
      error: function () { mostrarMensaje('Error al cargar segmentos.'); }
    });
  });

  $('#segmento').on('change', function () {
    const segmentoId = $(this).val();
    const tieneII = String($(this).find('option:selected').data('tiene-segmento-ii')) === 'true';

    limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
    limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
    toggleContainer('#segmento_ii_container', false);
    toggleContainer('#segmento_iii_container', false);
    $('#segmento_ii').prop('required', false);
    $('#segmento_iii').prop('required', false);

    // Limpiar categorías al cambiar segmento
    resetCategoriasDesdeNivel(1);

    if (tieneII) {
      toggleContainer('#segmento_ii_container', true);
      $('#segmento_ii').prop('required', true);
      $.ajax({
        url: '/api/segmentos-ii/',
        method: 'GET',
        data: { segmento_id: segmentoId },
        success: function (response) {
          limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
          if (response.length > 0) {
            response.forEach(s2 => $('#segmento_ii').append(`<option value="${s2.id}">${s2.nombre}</option>`));
          } else {
            mostrarMensaje('El segmento seleccionado no tiene segmentos II disponibles.');
          }
        },
        error: function () { mostrarMensaje('Error al cargar segmentos II.'); }
      });
    }
  });

  $('#segmento_ii').on('change', function () {
    const segII = $(this).val();
    limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
    toggleContainer('#segmento_iii_container', false);
    $('#segmento_iii').prop('required', false);

    if (!segII) return;

    $.ajax({
      url: '/api/segmentos-iii/',
      method: 'GET',
      data: { segmento_ii_id: segII },
      success: function (response) {
        if (response.length > 0) {
          toggleContainer('#segmento_iii_container', true);
          $('#segmento_iii').prop('required', true);
          limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
          response.forEach(s3 => $('#segmento_iii').append(`<option value="${s3.id}">${s3.nombre}</option>`));
          Swal.fire({ title:'Opciones adicionales disponibles', text:`Se encontraron ${response.length} opciones de Segmento III.`, icon:'info', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
        } else {
          setTimeout(() => { $('#tipificacion').focus(); }, 300);
        }
      },
      error: function () {
        setTimeout(() => { $('#tipificacion').focus(); }, 300);
      }
    });
  });

  $('#segmento_iii').on('change', function () {
    const t = $(this).find('option:selected').text();
    Swal.fire({ title:'Selección completada', text:`${t} seleccionado. Continúe con la tipificación.`, icon:'success', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
    setTimeout(() => { $('#tipificacion').focus(); }, 500);
  });

  // ==================== JERARQUÍA DE CATEGORÍAS (hasta 6 niveles) ====================
  function resetCategoriasDesdeNivel(nivel) {
    // Oculta y limpia todos los niveles >= nivel
    for (let i = nivel; i <= 6; i++) {
      const meta = nivelesCategorias[i];
      if (!meta) continue;
      limpiarSelect(meta.sel, 'Selecciona una opción');
      if (meta.cont) toggleContainer(meta.cont, false);
      $(meta.sel).prop('required', i === 1); // Solo nivel 1 requerido por defecto
    }
    // Campos especiales
    toggleContainer('#otros_delitos_container', false);
    $('#cual_otro_delito').prop('required', false).val('');
  }

  $('#tipificacion').on('change', function () {
    const tipId = $(this).val();
    if (!tipId) return;
    resetCategoriasDesdeNivel(1);

    // Nivel 1 (categoría)
    $.ajax({
      url: nivelesCategorias[1].endpoint,
      method: 'GET',
      data: { tipificacion_id: tipId },
      success: function (res) {
        if (res.length > 0) {
          limpiarSelect('#categoria', 'Selecciona una categoría');
          res.forEach(cat => $('#categoria').append(`<option value="${cat.id}">${cat.nombre}</option>`));
          $('#categoria').prop('required', true);
          $('#categoria_optional_label').hide();
          $('#categoria_required_label').show();
          Swal.fire({ title:'Categorías cargadas', text:`Se encontraron ${res.length} categoría(s).`, icon:'success', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
        } else {
          limpiarSelect('#categoria', 'Sin categorías - Tipificación directa');
          $('#categoria').prop('required', false);
          $('#categoria_optional_label').show();
          $('#categoria_required_label').hide();
          $('#categoria').append('<option value="0" selected>Sin categoría específica</option>');
          Swal.fire({ title:'Tipificación directa', text:'Esta tipificación no requiere selección de categoría.', icon:'info', timer:3000, showConfirmButton:false, toast:true, position:'top-end' });
        }
      },
      error: function () { mostrarMensaje('Error al cargar categorías.'); }
    });
  });

  // Handler genérico para cambio en cualquier nivel de categoría (1..5) para cargar el siguiente
  function onCambioNivelCategoria(nivelActual) {
    const metaActual = nivelesCategorias[nivelActual];
    const metaSiguiente = nivelesCategorias[nivelActual + 1];
    const $selActual = $(metaActual.sel);
    const idSel = $selActual.val();
    const textoSel = $selActual.find('option:selected').text() || '';

    // Otros delitos
    if (nivelActual <= 2) { // chequeamos en nivel 1 y 2 como en el original
      if (isOtrosDelitosLabel(textoSel)) {
        toggleContainer('#otros_delitos_container', true);
        $('#cual_otro_delito').prop('required', true);
      } else {
        toggleContainer('#otros_delitos_container', false);
        $('#cual_otro_delito').prop('required', false).val('');
      }
    }

    // Limpiar niveles siguientes
    resetCategoriasDesdeNivel(nivelActual + 1);

    if (!metaSiguiente || !idSel) return; // no hay más niveles o no hay selección

    // Cargar el siguiente nivel
    const params = (nivelActual === 1)
      ? { categoria_padre_id: idSel } // aunque nivel 2 usa /api/subcategorias/
      : { categoria_padre_id: idSel };

    $.ajax({
      url: metaSiguiente.endpoint,
      method: 'GET',
      data: params,
      success: function (res) {
        if (Array.isArray(res) && res.length > 0) {
          limpiarSelect(metaSiguiente.sel, 'Selecciona una opción');
          res.forEach(item => $(metaSiguiente.sel).append(`<option value="${item.id}">${item.nombre}</option>`));
          if (metaSiguiente.cont) toggleContainer(metaSiguiente.cont, true);
          $(metaSiguiente.sel).prop('required', true);

          // Mensajes informativos para algunos flujos conocidos (opcional)
          if (nivelActual === 2 && (idSel === '1037' || idSel === '1068')) {
            Swal.fire({ title:'Sub Categorías II cargadas', text:`Se encontraron ${res.length} opciones.`, icon:'info', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
          }
        }
      },
      error: function () {
        // Si el endpoint no existe (niveles 5/6 opcionales), simplemente no mostramos nada.
      }
    });
  }

  // Enlazar cambios de niveles 1..5
  $('#categoria').on('change', function () { onCambioNivelCategoria(1); });
  $('#subcategoria').on('change', function () { onCambioNivelCategoria(2); });
  $('#subcategoria_ii').on('change', function () {
    const texto = $(this).find('option:selected').text().toUpperCase();
    // Mantener compat con flujo NNA / ADULTO del original
    if (texto === 'NNA') {
      toggleContainer('#subcategoria_iii_container', false);
      $('#subcategoria_iii').prop('required', false);
      Swal.fire({ title:'Flujo NNA', text:'Puede proceder directamente a observaciones.', icon:'success', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
      setTimeout(() => { $('#observacion').focus(); }, 500);
      // Aún así, intentamos niveles siguientes si existen (para generalidad)
      onCambioNivelCategoria(3);
      return;
    }
    if (texto === 'ADULTO') {
      // Cargar nivel 4 y continuar
      onCambioNivelCategoria(3);
      return;
    }
    onCambioNivelCategoria(3);
  });
  $('#subcategoria_iii').on('change', function () { onCambioNivelCategoria(4); });
  $('#subcategoria_iv').on('change', function () { onCambioNivelCategoria(5); });

  // Cuando llega al último nivel
  $('#subcategoria_v').on('change', function () {
    const t = $(this).find('option:selected').text();
    Swal.fire({ title:'Flujo completado', text:`${t} seleccionado. Puede proceder a observaciones.`, icon:'success', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
    setTimeout(() => { $('#observacion').focus(); }, 500);
  });

  // ==================== VALIDACIONES ====================
  $('form').on('submit', function (e) {
    // Requeridos base
    const tipoCanal = $('#tipo_canal').val();
    const segmento  = $('#segmento').val();
    const tipif     = $('#tipificacion').val();
    if (!tipoCanal || !segmento || !tipif) {
      e.preventDefault(); mostrarMensaje('Por favor complete los campos de tipificación requeridos.'); return false;
    }

    // Categoría (nivel 1) si es requerida
    const catReq = $('#categoria').prop('required');
    if (catReq && !$('#categoria').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione una categoría.'); return false;
    }

    // Segmentos condicionales
    if ($('#segmento_ii_container').is(':visible') && $('#segmento_ii').prop('required') && !$('#segmento_ii').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione un Segmento II.'); return false;
    }
    if ($('#segmento_iii_container').is(':visible') && $('#segmento_iii').prop('required') && !$('#segmento_iii').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione un Segmento III.'); return false;
    }

    // Validar dinámicamente niveles de categorías visibles y requeridos (2..6)
    for (let n = 2; n <= 6; n++) {
      const meta = nivelesCategorias[n];
      if (!meta) continue;
      const visible = meta.cont ? $(meta.cont).is(':visible') : true;
      if (visible && $(meta.sel).prop('required') && !$(meta.sel).val()) {
        e.preventDefault();
        mostrarMensaje(`Por favor seleccione una opción en ${$(meta.sel).prev('label').text().trim()}.`);
        $(meta.sel).focus();
        return false;
      }
    }

    // "¿Cuál otro delito?"
    if ($('#otros_delitos_container').is(':visible') && $('#cual_otro_delito').prop('required')) {
      const v = $('#cual_otro_delito').val().trim();
      if (!v) { e.preventDefault(); mostrarMensaje('Por favor especifique cuál es el otro delito.'); $('#cual_otro_delito').focus(); return false; }
    }

    // Preguntas adicionales
    const uriSel = $('input[name="se_comunica_uri"]:checked').val();
    if (uriSel === '1' && !$('#ciudad_municipio_uri').val().trim()) {
      e.preventDefault(); mostrarMensaje('Por favor indique la ciudad/municipio de la URI.'); $('#ciudad_municipio_uri').focus(); return false;
    }
    const cj = $('input[name="consulta_juridica"]:checked').val();
    if (cj === '1' && !$('#abogado').val()) {
      e.preventDefault(); mostrarMensaje('Por favor seleccione un abogado para la consulta jurídica.'); $('#abogado').focus(); return false;
    }

    // Validación especial ciudadano
    if (ciudadanoExistente) {
      const cid = $('#cuidadano_id').val();
      if (!cid) { e.preventDefault(); mostrarMensaje('Error: ID de ciudadano no encontrado. Busque nuevamente el ciudadano.'); $('#numero_identificacion').focus(); return false; }
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); mostrarMensaje('Error en los datos del ciudadano. Por favor, busque nuevamente.'); $('#numero_identificacion').focus(); return false; }
      $('.campo-bloqueado').each(function () {
        if ($(this).is('select') && $(this).prop('disabled')) {
          $(this).prop('disabled', false).addClass('temp-enabled-for-submit');
        }
      });
    } else {
      const num = $('#numero_identificacion').val(), tid = $('#tipo_identificacion').val(), nom = $('#nombre').val();
      if (!num || !tid || !nom) { e.preventDefault(); mostrarMensaje('Por favor complete los datos básicos del ciudadano (Número ID, Tipo ID, Nombre).'); return false; }
    }

    return true;
  });

  // Re–deshabilitar selects bloqueados tras envío
  $('form').on('submit', function () {
    setTimeout(function () {
      $('.temp-enabled-for-submit').each(function () {
        $(this).prop('disabled', true).removeClass('temp-enabled-for-submit');
      });
    }, 100);
  });

  // ==================== LIMPIEZA (RESET) ====================
  function limpiarFormularioCompleto() {
    limpiarBusquedaCiudadano();

    // Preguntas adicionales
    $('input[name="se_comunica_uri"]').prop('checked', false);
    $('input[name="consulta_juridica"]').prop('checked', false);
    $('#ciudad_municipio_container').hide();
    $('#abogado_container').hide();
    $('#ciudad_municipio_uri').prop('required', false).val('');
    $('#abogado').prop('required', false).val('');

    // Reset categorías desde nivel 1
    resetCategoriasDesdeNivel(1);

    // Reset segmentos
    limpiarSelect('#tipo_canal', 'Seleccione un tipo de canal...');
    limpiarSelect('#segmento', 'Seleccione un segmento...');
    limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
    limpiarSelect('#segmento_iii', 'Seleccione un segmento III...');
    toggleContainer('#segmento_ii_container', false);
    toggleContainer('#segmento_iii_container', false);

    // Otros
    $('#conversacion_id').val('');
    $('#observacion').val('');
    $('#cual_otro_delito').val('');
  }

  $('#btn_limpiar, button[type="reset"]').on('click', function (e) {
    e.preventDefault();
    Swal.fire({
      title: '¿Limpiar formulario?',
      text: 'Se perderán todos los datos ingresados incluyendo las sub categorías.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, limpiar todo',
      cancelButtonText: 'Cancelar'
    }).then((r) => {
      if (r.isConfirmed) {
        limpiarFormularioCompleto();
        mostrarMensaje('Formulario limpiado correctamente.', 'success');
      }
    });
  });

  // ==================== EXTRAS UI ====================
  $(document).on('keydown', '.campo-bloqueado', function (e) {
    const ok = [9,16,17,18,27,37,38,39,40].includes(e.keyCode);
    if (!ok) { e.preventDefault(); return false; }
  });
  $(document).on('mousedown', 'select.campo-bloqueado', function (e) { e.preventDefault(); return false; });
  $(document).on('mouseenter', '.campo-bloqueado', function () { $(this).attr('title', 'Campo bloqueado - Ciudadano existente'); });

  $('#conversacion_id').on('input', function () {
    const v = $(this).val();
    const ok = v.length >= 5;
    $(this).toggleClass('is-invalid', !ok && v.length > 0);
    $(this).toggleClass('is-valid', ok);
  });

  // ==================== INICIALIZACIÓN ====================
  $('#numero_identificacion').focus();
  actualizarEstadoCiudadano(false);
});
</script>

<!-- Script adicional: lógica de “Anónimo” por rol -->
<script>
(function(){
  const IS_SUPERVISOR = {% if is_supervisor %}true{% else %}false{% endif %};
  const NUMERO_ANONIMO = "{{ numero_anonimo|default:'9999999' }}";

  const $chkAnon   = $('#es_anonimo');
  const $numId     = $('#numero_identificacion');
  const $correo    = $('#correo');
  const $tel       = $('#telefono');
  const $inconcer  = $('#telefono_inconcer');
  const $wrapIncon = $('#wrap_telefono_inconcer');

  const CAMPOS_BLOQUEAR = ['#tipo_identificacion','#nombre','#direccion_residencia','#pais','#ciudad'];

  function setDisabled(selOrArr, val){
    const list = Array.isArray(selOrArr) ? selOrArr : [selOrArr];
    list.forEach(sel => {
      const $el = $(sel);
      if (!$el.length) return;
      $el.prop('disabled', val).prop('readonly', val);
      if (val) { $el.addClass('campo-bloqueado'); } else { $el.removeClass('campo-bloqueado'); }
    });
  }

  function syncAnonFlag(){
    const anon = ($numId.val().trim() === NUMERO_ANONIMO) || $chkAnon.is(':checked');
    $chkAnon.prop('checked', anon);
    return anon;
  }

  window.applyAnonUI = function applyAnonUI(){
    if (IS_SUPERVISOR){
      $wrapIncon.hide();
      return;
    }
    const anon = syncAnonFlag();
    setDisabled(CAMPOS_BLOQUEAR, anon);
    setDisabled([$correo, $tel], false);
    $wrapIncon.show();
    setDisabled($inconcer, false);

    if (anon){
      $correo.attr('placeholder','Correo de contacto (anónimo)');
      $tel.attr('placeholder','Teléfono del que se comunica (anónimo)');
      $inconcer.attr('placeholder','Teléfono Inconcer (anónimo)');
    } else {
      $correo.attr('placeholder','');
      $tel.attr('placeholder','Teléfono del que se comunica');
      $inconcer.attr('placeholder','Teléfono que llega desde Inconcer');
    }
  };

  $numId.on('input change blur', function(){ applyAnonUI(); });
  applyAnonUI();
})();
</script>
{% endblock %}

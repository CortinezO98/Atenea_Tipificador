{% extends "usuarios/base/base.html" %}
{% load static %}

{% block title %}{% if user %}Editar{% else %}Crear{% endif %} Usuario{% endblock %}

{% block content %}
<div class="container py-5 d-flex justify-content-center align-items-center" style="min-height: 100vh;">
  <div class="col-md-10 col-lg-8">
    <div class="d-flex justify-content-center align-items-center mb-4 gap-3">
      <img src="{% static 'img/Latenea.png' %}" alt="Fiscal√≠a" style="height: 80px;">
      <img src="{% static 'img/logo_iq.png' %}" alt="IQ Outsourcing" style="height: 80px;">
    </div>
    <div class="card shadow-lg rounded-4 border-0 bg-light animate__animated animate__fadeIn">
      <div class="card-header bg-primary text-white text-center rounded-top-4">
        <h5 class="mb-0 text-white">
          <i class="bi bi-person-plus me-2"></i>
          {% if user %}Editar Usuario{% else %}Crear Usuario{% endif %}
        </h5>
      </div>
      <div class="card-body p-4">
        <form method="post"
              id="crearUsuarioForm"
              novalidate
              autocomplete="off">
          {% csrf_token %}
          <div class="row g-3">
            <!-- Username -->
            <div class="col-md-6">
              <label for="id_username" class="form-label">Usuario*</label>
              <input type="text"
                     name="username"
                     class="form-control {% if form.username.errors %}is-invalid{% endif %}"
                     id="id_username"
                     value="{{ user.username|default:'' }}"
                     required>
              {% if form.username.errors %}
                <div class="invalid-feedback">
                  {% for error in form.username.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Email -->
            <div class="col-md-6">
              <label for="id_email" class="form-label">Correo Electr√≥nico*</label>
              <input type="email"
                     name="email"
                     class="form-control {% if form.email.errors %}is-invalid{% endif %}"
                     id="id_email"
                     value="{{ user.email|default:'' }}"
                     required>
              {% if form.email.errors %}
                <div class="invalid-feedback">
                  {% for error in form.email.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Nombres -->
            <div class="col-md-6">
              <label for="id_first_name" class="form-label">Nombres*</label>
              <input type="text"
                     name="first_name"
                     class="form-control {% if form.first_name.errors %}is-invalid{% endif %}"
                     id="id_first_name"
                     value="{{ user.first_name|default:'' }}"
                     required>
              {% if form.first_name.errors %}
                <div class="invalid-feedback">
                  {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Apellidos -->
            <div class="col-md-6">
              <label for="id_last_name" class="form-label">Apellidos*</label>
              <input type="text"
                     name="last_name"
                     class="form-control {% if form.last_name.errors %}is-invalid{% endif %}"
                     id="id_last_name"
                     value="{{ user.last_name|default:'' }}"
                     required>
              {% if form.last_name.errors %}
                <div class="invalid-feedback">
                  {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Contrase√±a -->
            <div class="col-md-6">
              <label for="id_password" class="form-label">
                {% if user %}Nueva Contrase√±a{% else %}Contrase√±a*{% endif %}
              </label>
              <div class="input-group has-validation">
                <input type="password"
                       name="password"
                       class="form-control {% if form.password.errors %}is-invalid{% endif %}"
                       id="id_password"
                       {% if not user %}required{% endif %}
                       autocomplete="new-password">
                <button class="btn btn-outline-secondary toggle-password"
                        type="button"
                        data-target="id_password"
                        aria-label="Mostrar u ocultar contrase√±a">
                  <i class="bi bi-eye"></i>
                </button>
                <div class="invalid-feedback">
                  {% for error in form.password.errors %}{{ error }}{% endfor %}
                </div>
              </div>
              <small class="text-muted">M√≠nimo 8 caracteres</small>
              <div class="password-strength mt-1">
                <div class="progress" style="height: 5px;">
                  <div class="progress-bar"
                       id="password-strength-bar"
                       role="progressbar"
                       style="width: 0%"></div>
                </div>
              </div>
            </div>

            <!-- Confirmar Contrase√±a -->
            <div class="col-md-6">
              <label for="id_confirm_password" class="form-label">
                {% if user %}Confirmar Nueva Contrase√±a{% else %}Confirmar Contrase√±a*{% endif %}
              </label>
              <div class="input-group has-validation">
                <input type="password"
                       name="confirm_password"
                       class="form-control {% if form.confirm_password.errors %}is-invalid{% endif %}"
                       id="id_confirm_password"
                       {% if not user %}required{% endif %}
                       autocomplete="new-password">
                <button class="btn btn-outline-secondary toggle-password"
                        type="button"
                        data-target="id_confirm_password"
                        aria-label="Mostrar u ocultar confirmaci√≥n de contrase√±a">
                  <i class="bi bi-eye"></i>
                </button>
                <div class="invalid-feedback">
                  {% for error in form.confirm_password.errors %}{{ error }}{% endfor %}
                </div>
              </div>
              <div class="mt-2" id="password-match-feedback">
                <small id="password-match-text" class="text-muted"></small>
                <i id="password-match-icon" class="bi ms-1 d-none"></i>
              </div>
            </div>

            <!-- Rol -->
            <div class="col-md-6">
              <label for="id_rol" class="form-label">Rol*</label>
              <select class="form-select {% if form.rol.errors %}is-invalid{% endif %}"
                      id="id_rol"
                      name="rol"
                      required>
                <option value="">Seleccione un rol</option>
                {% for grupo in grupos %}
                  <option value="{{ grupo.id }}"
                    {% if grupo_asignado and grupo.id == grupo_asignado.id %}selected{% endif %}>
                    {{ grupo.name }}
                  </option>
                {% endfor %}
              </select>
              {% if form.rol.errors %}
                <div class="invalid-feedback">
                  {% for error in form.rol.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Estado (Activo/Inactivo) -->
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input"
                       type="checkbox"
                       id="id_is_active"
                       name="is_active"
                       {% if not user or user.is_active %}checked{% endif %}>
                <label class="form-check-label" for="id_is_active">Usuario Activo</label>
              </div>
            </div>

            <!-- Botones -->
            <div class="col-12 text-center mt-4">
              <button type="submit"
                      class="btn btn-primary me-2"
                      id="submitBtn">
                <i class="bi bi-save me-1"></i>
                {% if user %}Actualizar Usuario{% else %}Crear Usuario{% endif %}
              </button>
              <a href="{% url 'dashboard_admin' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Cancelar
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="text-center mt-3">
      <small class="text-muted">¬© ATENEA - IQ Outsourcing - {% now "Y" %}</small>
    </div>
  </div>
</div>

<script>
(function () {
  "use strict";

  // üîí NO se loguean contrase√±as, NO se env√≠an a servicios externos.
  // Todo el manejo es local al navegador y solo se env√≠an al backend v√≠a POST normal.

  // Toggle para mostrar/ocultar contrase√±a
  document.querySelectorAll(".toggle-password").forEach(function (button) {
    button.addEventListener("click", function () {
      const targetId = this.dataset.target;
      const target = document.getElementById(targetId);
      const icon = this.querySelector("i");

      if (!target) {
        return;
      }

      if (target.type === "password") {
        target.type = "text";
        if (icon) {
          icon.classList.replace("bi-eye", "bi-eye-slash");
        }
      } else {
        target.type = "password";
        if (icon) {
          icon.classList.replace("bi-eye-slash", "bi-eye");
        }
      }
    });
  });

  // Evaluar fortaleza de la contrase√±a (sin exponer el valor)
  function getStrengthCategory(rawValue) {
    if (!rawValue) {
      return "none";
    }

    let score = 0;
    if (rawValue.length >= 8) score++;
    if (/\d/.test(rawValue)) score++;
    if (/[A-Z]/.test(rawValue)) score++;
    if (/[^A-Za-z0-9]/.test(rawValue)) score++;

    if (score <= 1) return "weak";
    if (score === 2) return "medium";
    if (score === 3) return "strong";
    return "very-strong";
  }

  function updatePasswordFeedback() {
    const pwdField = document.getElementById("id_password");
    const confirmField = document.getElementById("id_confirm_password");
    const matchFeedback = document.getElementById("password-match-text");
    const matchIcon = document.getElementById("password-match-icon");
    const strengthBar = document.getElementById("password-strength-bar");

    if (!pwdField || !confirmField || !matchFeedback || !matchIcon || !strengthBar) {
      return;
    }

    const pwdVal = pwdField.value || "";
    const confirmVal = confirmField.value || "";

    // === Barra de fortaleza (solo muestra una categor√≠a, no el contenido) ===
    const category = getStrengthCategory(pwdVal);
    let width = 0;
    let barClass = "progress-bar";

    if (category === "weak") {
      width = 33;
      barClass = "progress-bar bg-danger";
    } else if (category === "medium") {
      width = 66;
      barClass = "progress-bar bg-warning";
    } else if (category === "strong" || category === "very-strong") {
      width = 100;
      barClass = "progress-bar bg-success";
    }

    strengthBar.style.width = width + "%";
    strengthBar.className = barClass;

    // === Coincidencia de contrase√±as (solo indica si coinciden, sin mostrar valores) ===
    if (pwdVal && confirmVal) {
      if (pwdVal === confirmVal) {
        matchFeedback.textContent = "Las contrase√±as coinciden";
        matchFeedback.className = "text-success";
        matchIcon.className = "bi bi-check-circle-fill text-success ms-1";
        matchIcon.classList.remove("d-none");
      } else {
        matchFeedback.textContent = "Las contrase√±as no coinciden";
        matchFeedback.className = "text-danger";
        matchIcon.className = "bi bi-x-circle-fill text-danger ms-1";
        matchIcon.classList.remove("d-none");
      }
    } else {
      matchFeedback.textContent = "";
      matchFeedback.className = "text-muted";
      matchIcon.className = "bi ms-1 d-none";
    }
  }

  const pwdField = document.getElementById("id_password");
  const confirmField = document.getElementById("id_confirm_password");

  if (pwdField) {
    pwdField.addEventListener("input", updatePasswordFeedback);
  }
  if (confirmField) {
    confirmField.addEventListener("input", updatePasswordFeedback);
  }

  // Validaci√≥n del formulario antes de enviar
  const form = document.getElementById("crearUsuarioForm");
  if (form) {
    form.addEventListener("submit", function (e) {
      const submitBtn = document.getElementById("submitBtn");
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
      }

      const pwdVal = pwdField ? pwdField.value || "" : "";
      const confirmVal = confirmField ? confirmField.value || "" : "";

      // Validaci√≥n local ‚Äì no se loguea ni se env√≠a la contrase√±a a servicios externos
      if (pwdVal && pwdVal.length < 8) {
        e.preventDefault();
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<i class="bi bi-save me-1"></i> {% if user %}Actualizar Usuario{% else %}Crear Usuario{% endif %}';
        }
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "La contrase√±a debe tener al menos 8 caracteres",
          confirmButtonColor: "#0d6efd"
        });
        return;
      }

      if (pwdVal !== confirmVal) {
        e.preventDefault();
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<i class="bi bi-save me-1"></i> {% if user %}Actualizar Usuario{% else %}Crear Usuario{% endif %}';
        }
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Las contrase√±as no coinciden",
          confirmButtonColor: "#0d6efd"
        });
        return;
      }
    });
  }

  // Inicializar verificaci√≥n si hay valores al cargar
  document.addEventListener("DOMContentLoaded", function () {
    if (
      (pwdField && pwdField.value) ||
      (confirmField && confirmField.value)
    ) {
      updatePasswordFeedback();
    }
  });
})();
</script>
{% endblock %}
